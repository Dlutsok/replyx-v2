# Changelog - ReplyX MVP 13

## 2025-09-19 - Major Updates and Bug Fixes

### üöÄ New Features

#### Admin Chat Analytics System
- **–ù–æ–≤–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —á–∞—Ç–æ–≤**
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —á–∞—Ç–æ–≤" –≤ –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
  - –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —á–∞—Ç–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω—ã—Ö –ø–µ—Ä–µ–ø–∏—Å–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö

**–§–∞–π–ª—ã:**
- `backend/api/admin_chats.py` - –Ω–æ–≤—ã–π API –º–æ–¥—É–ª—å
- `frontend/pages/admin-chats.js` - –Ω–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- `frontend/components/layout/AdminDashboard.js` - –æ–±–Ω–æ–≤–ª–µ–Ω–æ –º–µ–Ω—é
- `frontend/pages/_app.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω –º–∞—Ä—à—Ä—É—Ç –≤ ADMIN_ROUTES

**API Endpoints:**
- `GET /api/admin/chats/overview` - –æ–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —á–∞—Ç–∞–º
- `GET /api/admin/chats/users` - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- `GET /api/admin/chats/user/{user_id}/dialogs` - –¥–∏–∞–ª–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /api/admin/chats/dialog/{dialog_id}/messages` - —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞

### üêõ Bug Fixes

#### 1. Yandex Search Engine Indexing
**–ü—Ä–æ–±–ª–µ–º–∞:** –Ø–Ω–¥–µ–∫—Å –Ω–µ –º–æ–≥ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å favicon –∏ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã —è–≤–Ω—ã–µ SEO –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

```javascript
// frontend/next.config.js
{
  source: '/',
  headers: [
    {
      key: 'X-Robots-Tag',
      value: 'index, follow'
    }
  ]
}
```

#### 2. Registration 500 Error
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ `get_db_stats`
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –∏–º–ø–æ—Ä—Ç –≤ database/__init__.py

```python
# backend/database/__init__.py
from .connection import engine, Base, SessionLocal, get_db, get_db_stats
__all__ = ['engine', 'Base', 'SessionLocal', 'get_db', 'get_db_stats', 'models', 'schemas', 'crud', 'auth']
```

#### 3. Custom Welcome Messages in Widget
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∏–¥–∂–µ—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ welcomeMessage —á–µ—Ä–µ–∑ iframe URL

```javascript
// frontend/public/widget.js
if (widgetConfig.widget_settings && widgetConfig.widget_settings.welcomeMessage) {
  iframeSrc += `&welcomeMessage=${encodeURIComponent(widgetConfig.widget_settings.welcomeMessage)}`;
}

// frontend/pages/chat-iframe.js
const welcomeMessageParam = params.get('welcomeMessage');
if (welcomeMessageParam) {
  setWelcomeMessage(decodeURIComponent(welcomeMessageParam));
}
```

#### 4. Line Breaks in Welcome Messages
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ —Å –ø–æ–º–æ—â—å—é React —ç–ª–µ–º–µ–Ω—Ç–æ–≤

```javascript
// frontend/pages/chat-iframe.js
{welcomeMessage.split('\n').map((line, index) => (
  <span key={index}>
    {line}
    {index < welcomeMessage.split('\n').length - 1 && <br />}
  </span>
))}
```

#### 5. Backend Database Model Issues
**–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:**

- **'channel' attribute error:** –ú–æ–¥–µ–ª—å Dialog –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª—è 'channel'
  - **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ telegram_chat_id –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ (telegram vs website)

- **SQL nested aggregation error:** PostgreSQL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç avg(count(...))
  - **–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ Python –∫–æ–¥–µ

- **'full_name' attribute error:** –ú–æ–¥–µ–ª—å User –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ 'first_name'
  - **–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ full_name –Ω–∞ first_name

- **FiBot icon import error:** –ò–∫–æ–Ω–∫–∞ FiBot –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ react-icons/fi
  - **–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∞ –Ω–∞ FiCpu –∏–∫–æ–Ω–∫—É

### üîí Security

**–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:**
- Backend: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `auth.get_current_admin`
- Frontend: –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ _app.tsx
- Component-level: –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### üìä Technical Improvements

#### Database Schema Optimizations
- –£–ª—É—á—à–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—è–º–∏ telegram_chat_id –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —á–∞—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö

#### API Response Models
–°–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:
- `UserChatOverview` - –æ–±–∑–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- `UserChatStats` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `DialogOverview` - –æ–±–∑–æ—Ä –¥–∏–∞–ª–æ–≥–∞
- `UserDialogsDetail` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–∞–ª–æ–≥–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `DialogMessageDetail` - –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `ChatAnalyticsOverview` - –æ–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —á–∞—Ç–æ–≤

#### Frontend Enhancements
- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–ø–∏—Å–æ–∫
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∑–∞–≥—Ä—É–∑–∫–∏

### üß™ Testing & Quality Assurance

- –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ –≤–∏–¥–∂–µ—Ç–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–∞–π—Ç–∞—Ö
- –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞

### üìù Technical Notes

**–í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:**
1. –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π API –º–æ–¥—É–ª—å –¥–ª—è –∞–¥–º–∏–Ω-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏
2. –†–∞—Å—à–∏—Ä–µ–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –≤–∏–¥–∂–µ—Ç–µ
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–§–∞–π–ª—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏:**
- `backend/api/admin_chats.py` - –Ω–æ–≤—ã–π API –º–æ–¥—É–ª—å
- `frontend/pages/admin-chats.js` - –Ω–æ–≤–∞—è –∞–¥–º–∏–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü–∞
- `frontend/public/widget.js` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤–∏–¥–∂–µ—Ç–∞
- `frontend/pages/chat-iframe.js` - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### üîÑ Migration Notes

–ü—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å –≤:
1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∞–¥–º–∏–Ω-—Ä–æ–ª–µ–π
2. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ –≤—Å–µ—Ö API endpoints
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
4. –ü—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–∞–π—Ç–∞—Ö

---

**–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∏–ª–∞ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —á–∞—Ç–æ–≤, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –≤–∏–¥–∂–µ—Ç–æ–≤, —É–ª—É—á—à–µ–Ω–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω-—Å—Ä–µ–¥—ã.