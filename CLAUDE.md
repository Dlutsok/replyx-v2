# CLAUDE.md

Этот файл предоставляет рекомендации для Claude Code (claude.ai/code) при работе с кодом в данном репозитории.

## Команды разработки

### Frontend (Next.js)
- `npm run dev` - Запуск сервера разработки на http://localhost:3000 
- `npm run build` - Сборка продакшен версии
- `npm start` - Запуск продакшен сервера

### Backend (FastAPI + Python)
- `python main.py` - Запуск FastAPI сервера
- Управление ботами:
  - `npm run start-bots` - Запуск системы ботов
  - `npm run stop-bots` - Остановка всех ботов
  - `npm run restart-bots` - Перезапуск системы ботов
  - `npm run status` - Проверка статуса ботов
  - `npm run logs` - Просмотр логов ботов

### Тестирование и обслуживание
- `make test` - Запуск всех unit-тестов
- `make test-db` - Тестирование целостности базы данных
- `make test-api` - Тестирование API endpoints
- `make snapshot` - Создание системного снимка
- `make db-status` - Проверка статуса базы данных
- `make db-cleanup` - Очистка и оптимизация базы данных

## Обзор архитектуры

### Full-Stack архитектура
- **Frontend**: Next.js с TypeScript, CSS модули, анимации Framer Motion
- **Backend**: FastAPI с SQLAlchemy ORM и PostgreSQL
- **Система ботов**: Масштабируемый Node.js менеджер ботов с интеграцией Telegram
- **База данных**: PostgreSQL с миграциями Alembic

### Ключевые системы

**Аутентификация и авторизация**
- JWT-аутентификация с ролевым доступом (пользователь/админ)
- OAuth интеграция (Яндекс, Google) 
- Система подтверждения email
- Управление сессиями с автоматическим обновлением

**Управление AI ассистентами**  
- Поддержка множественных ассистентов с индивидуальными настройками
- Система загрузки документов и эмбеддингов через OpenAI
- База знаний с векторным поиском
- Чат-интерфейс с WebSocket коммуникацией в реальном времени

**Инфраструктура ботов**
- Масштабируемый менеджер Telegram ботов (`master/scalable_bot_manager.js`)
- Поддержка множественных экземпляров ботов с автоматическим масштабированием
- WebSocket интеграция для обновлений в реальном времени
- Управление жизненным циклом ботов с мониторингом здоровья

**Схема базы данных**
- Пользователи с системой онбординга и управления триалом
- Ассистенты с эмбеддингами документов и историей чата
- Система баланса/биллинга с промокодами и рефералами
- Комплексное аудит-логирование и мониторинг

### Структура проекта

**Frontend** (`/frontend/`)
- Страницы: Авторизация, дашборд, диалоги, управление AI ассистентами
- Компоненты: Модульный UI с системой макетов (Header, Sidebar, DashboardLayout)
- Хуки: Аутентификация (`useAuth`), данные дашборда (`useDashboardData`)
- Стилизация: CSS модули с адаптивным дизайном и темными/светлыми темами

**Backend** (`/backend/`)
- API маршруты в `/api/` (auth, assistants, dialogs, bots и т.д.)
- Модели и схемы базы данных в `/database/`
- AI интеграция в `/ai/` с OpenAI и сервисами эмбеддингов
- Управление ботами в `/services/` и `/master/`
- Система миграций с Alembic в `/alembic/versions/`

### Мобильная адаптивность
- Адаптивный сайдбар, который сворачивается на мобильных с гамбургер-меню
- Карточные макеты автоматически переключаются в мобильно-дружелюбный формат
- Touch-оптимизированный интерфейс с правильными областями касания
- Предотвращение зума iOS на полях ввода

### Рабочий процесс разработки
- Миграции базы данных управляются через Alembic
- Система ботов использует Node.js кластер для масштабируемости  
- WebSocket соединения для функций реального времени
- Комплексная обработка ошибок и система логирования
- Системный мониторинг с утилитами Makefile для диагностики

### Конфигурация
- Переменные окружения для API ключей и подключений к базе данных
- CORS конфигурация для локальной разработки
- JWT секрет и настройки времени истечения токенов
- Пулинг подключений базы данных и оптимизация
- Управление токенами ботов с поддержкой ротации

### Критические зависимости
- Frontend: Next.js 13+, React 18, Framer Motion, React Icons
- Backend: FastAPI, SQLAlchemy, OpenAI SDK, python-jose
- Система ботов: node-telegram-bot-api, Express.js
- База данных: PostgreSQL с psycopg2-binary

## Ключевые заметки по реализации

### Поток аутентификации
1. Редиректы входа устанавливают роль пользователя и токен в localStorage
2. Защищенные маршруты проверяют аутентификацию в _app.tsx
3. API вызовы включают Bearer токен в заголовке Authorization
4. WebSocket соединения аутентифицируются через параметр запроса

### Развертывание ботов
- Боты управляются Node.js главным процессом с кластеризацией воркеров
- Каждый ассистент может иметь множественные экземпляры ботов на разных платформах
- Конфигурация ботов включает Telegram токены, вебхуки и маппинг ассистентов
- Система автоматически обрабатывает перезапуски ботов и мониторинг здоровья

### Поток данных
- Frontend компоненты используют кастомные хуки для получения данных
- Обновления в реальном времени через WebSocket соединения с backend
- Запросы к базе данных оптимизированы с индексами и пулингом соединений
- Загрузка файлов обрабатывается с multipart формами и валидацией

Всегда запускайте `make db-status` перед крупными операциями с базой данных и `npm run status` для проверки здоровья системы ботов.