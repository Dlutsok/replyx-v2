# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π CORS –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤ ReplyX

## üìã –û–±–∑–æ—Ä –∑–∞–¥–∞—á–∏

–í —Ä–∞–º–∫–∞—Ö –¥–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ –±—ã–ª–∞ —Ä–µ—à–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ CORS (Cross-Origin Resource Sharing) –≤ —Å–∏—Å—Ç–µ–º–µ –≤–∏–¥–∂–µ—Ç–æ–≤ ReplyX, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–Ω–∏–∫–ª–∞ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä.

**–ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –î–ª—è —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∂–µ—Ç–æ–≤ –Ω–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–∞–π—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, stencom.ru) –±—ã–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `CORS_ORIGINS="*"`, —á—Ç–æ –æ—Ç–∫—Ä—ã–ª–æ –¥–æ—Å—Ç—É–ø –∫ API —Å–æ –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ - —Å–µ—Ä—å–µ–∑–Ω–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## üéØ –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é CORS –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è:
- –ó–∞–∫—Ä–æ–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã–π –¥–æ—Å—Ç—É–ø `CORS_ORIGINS="*"`
- –°–æ—Ö—Ä–∞–Ω–∏—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–∂–µ—Ç–æ–≤ –Ω–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–∞–π—Ç–∞—Ö
- –û–±–µ—Å–ø–µ—á–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üìä –≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ß—Ç–æ –¥–µ–ª–∞–ª–∏:**
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ —Ç–µ–∫—É—â—É—é CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `backend/main.py`
- –ò–∑—É—á–∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –≤–∏–¥–∂–µ—Ç —Å–∏—Å—Ç–µ–º—ã –∏ JWT-—Ç–æ–∫–µ–Ω—ã
- –í—ã—è–≤–∏–ª–∏ –≤—Å–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ò—Å—Å–ª–µ–¥–æ–≤–∞–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–æ–≤: `/api/validate-widget-token` –∏ `/api/widget-config`

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
1. **CORS_ORIGINS="*"** - –æ—Ç–∫—Ä—ã—Ç –¥–æ—Å—Ç—É–ø —Å–æ –í–°–ï–• –¥–æ–º–µ–Ω–æ–≤
2. **allow_credentials=false** –ø—Ä–∏ "*" - –±–ª–æ–∫–∏—Ä—É–µ—Ç cookies/JWT –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. **–ï–¥–∏–Ω—ã–π CORS –¥–ª—è –≤—Å–µ–≥–æ API** - –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏ –≤–∏–¥–∂–µ—Ç–∞–º–∏
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–æ–º–µ–Ω–æ–≤** —á–µ—Ä–µ–∑ JWT-—Ç–æ–∫–µ–Ω—ã –≤–∏–¥–∂–µ—Ç–æ–≤

### –≠—Ç–∞–ø 2: –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è:**
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π CORS middleware** –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫**: –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å credentials) vs –≤–∏–¥–∂–µ—Ç—ã (–±–µ–∑ credentials)
- **JWT-–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤**: –≤–∏–¥–∂–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º–∏ –≤ —Ç–æ–∫–µ–Ω–µ –¥–æ–º–µ–Ω–∞–º–∏
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**: –º–µ—Ç—Ä–∏–∫–∏ –≤—Å–µ—Ö CORS –∑–∞–ø—Ä–æ—Å–æ–≤

### –≠—Ç–∞–ø 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è DynamicCORSMiddleware

**–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª:** `backend/core/dynamic_cors_middleware.py`

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è**: –ø—Ä–æ–≤–µ—Ä–∫–∞ origin —á–µ—Ä–µ–∑ JWT-—Ç–æ–∫–µ–Ω—ã –≤–∏–¥–∂–µ—Ç–æ–≤
- **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤, www-–ø—Ä–µ—Ñ–∏–∫—Å–æ–≤, —Ä–µ–≥–∏—Å—Ç—Ä–∞
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: credentials —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –≤—Å–µ—Ö CORS —Ä–µ—à–µ–Ω–∏–π

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:**
```
1. –ü–æ–ª—É—á–∏—Ç—å Origin –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (–≤–∏–¥–∂–µ—Ç –∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
3. –î–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤
4. –î–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤: 
   - OPTIONS –∑–∞–ø—Ä–æ—Å—ã: —Ä–∞–∑—Ä–µ—à–∏—Ç—å (–≤–∞–ª–∏–¥–∞—Ü–∏—è –±—É–¥–µ—Ç –≤ —Å–∞–º–æ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ)
   - POST –∑–∞–ø—Ä–æ—Å—ã: —Ä–∞–∑—Ä–µ—à–∏—Ç—å (—Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ)
   - GET –∑–∞–ø—Ä–æ—Å—ã: –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å JWT-—Ç–æ–∫–µ–Ω –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
6. –ó–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```

### –≠—Ç–∞–ø 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `backend/main.py`:**
- –ò–º–ø–æ—Ä—Ç `DynamicCORSMiddleware`
- –ó–∞–º–µ–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ `CORSMiddleware` –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏: –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–º–µ–Ω—ã vs –≤–∏–¥–∂–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è "*" –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ CORS_ORIGINS

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `backend/core/app_config.py`:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è "*" –∏–∑ CORS_ORIGINS –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ Prometheus –º–µ—Ç—Ä–∏–∫–∏:**
- `widget_cors_requests_total` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ CORS –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–∏–¥–∂–µ—Ç–æ–≤
- `widget_token_validations_total` - –ø–æ–ø—ã—Ç–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT-—Ç–æ–∫–µ–Ω–æ–≤
- `widget_blocked_origins_total` - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –≤ middleware:**
- –ó–∞–ø–∏—Å—å –≤—Å–µ—Ö CORS —Ä–µ—à–µ–Ω–∏–π (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ)
- –¢—Ä–µ–∫–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

**–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π –¥–æ–º–µ–Ω (https://replyx.ru)
2. ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –¥–æ–º–µ–Ω (https://evil.com)
3. ‚úÖ –í–∏–¥–∂–µ—Ç —Å –≤–∞–ª–∏–¥–Ω—ã–º JWT-—Ç–æ–∫–µ–Ω–æ–º (POST –∑–∞–ø—Ä–æ—Å)
4. ‚úÖ –í–∏–¥–∂–µ—Ç preflight –∑–∞–ø—Ä–æ—Å (OPTIONS)
5. ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤ (–ø—Ä–æ—Ç–æ–∫–æ–ª—ã, www, —Ä–µ–≥–∏—Å—Ç—Ä)
6. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–≤–∏–¥–∂–µ—Ç vs –æ—Å–Ω–æ–≤–Ω–æ–µ)

## üîê –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –î–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- **CORS –¥–æ–º–µ–Ω—ã**: —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–±–µ–∑ "*")
- **Credentials**: —Ä–∞–∑—Ä–µ—à–µ–Ω—ã (cookies, JWT —Ç–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç)
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- **–ü—Ä–∏–º–µ—Ä—ã –¥–æ–º–µ–Ω–æ–≤**: `https://replyx.ru`, `http://localhost:3000`

### –î–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤:
- **CORS –¥–æ–º–µ–Ω—ã**: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JWT-—Ç–æ–∫–µ–Ω—ã
- **Credentials**: –∑–∞–ø—Ä–µ—â–µ–Ω—ã (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ JWT –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ `allowed_domains`
- **–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã**: `/api/validate-widget-token`, `/api/widget-config`

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è:
1. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö "*" –¥–æ–º–µ–Ω–æ–≤
2. **–ì–∏–±–∫–æ—Å—Ç—å**: –≤–∏–¥–∂–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–∞—Ö —á–µ—Ä–µ–∑ JWT
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–¥–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å**: –ø–æ–ª–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—Å–µ—Ö CORS —Ä–µ—à–µ–Ω–∏–π
5. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **–ó–∞–∫—Ä—ã—Ç CORS_ORIGINS="*"** - —É–±—Ä–∞–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã credentials** –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–î–æ–±–∞–≤–ª–µ–Ω–∞ JWT-–≤–∞–ª–∏–¥–∞—Ü–∏—è** –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤
- **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- **–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
- **–í–∏–¥–∂–µ—Ç—ã** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –Ω–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–∞–π—Ç–∞—Ö
- **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** –¥–æ—Å—Ç—É–ø–Ω–∞ —Å credentials
- **API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã** –∑–∞—â–∏—â–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏

### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å:
- **Prometheus –º–µ—Ç—Ä–∏–∫–∏** –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** CORS —Ä–µ—à–µ–Ω–∏–π
- **–¢—Ä–µ–∫–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
backend/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ dynamic_cors_middleware.py  # –ù–æ–≤—ã–π CORS middleware
‚îÇ   ‚îî‚îÄ‚îÄ app_config.py              # –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è "*"
‚îî‚îÄ‚îÄ main.py                        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è middleware + –º–µ—Ç—Ä–∏–∫–∏
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–ª–∞—Å—Å—ã –∏ –º–µ—Ç–æ–¥—ã:
- `DynamicCORSMiddleware.__init__()` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫
- `DynamicCORSMiddleware.dispatch()` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ CORS
- `DynamicCORSMiddleware.validate_widget_origin()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT
- `DynamicCORSMiddleware.normalize_domain()` - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤
- `DynamicCORSMiddleware._record_widget_metrics()` - –∑–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `PyJWT` - –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
- `prometheus_client` - –¥–ª—è –º–µ—Ç—Ä–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `starlette` - –±–∞–∑–æ–≤—ã–π HTTP middleware
- `fastapi` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º CORS
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–≤–µ—Ä—Ö–µ–¥ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: extensive —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ø–æ–ª–Ω–∞—è –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –≤ Prometheus/Grafana
5. **–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ**: –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –º–µ—Ç—Ä–∏–∫–æ–π `widget_blocked_origins_total` - —Ä–æ—Å—Ç –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –∞—Ç–∞–∫–∏
- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å `widget_token_validations_total{result="invalid"}` - –ø–æ–¥–¥–µ–ª–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ —É—Ä–æ–≤–Ω—è WARNING –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤:
```
# Grafana Alert: –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–∏–¥–∂–µ—Ç–æ–≤
increase(widget_blocked_origins_total[5m]) > 10
```

### –†–∞–∑–≤–∏—Ç–∏–µ —Å–∏—Å—Ç–µ–º—ã:
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –≤–∏–¥–∂–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤: –æ–±–Ω–æ–≤–∏—Ç—å `widget_endpoints` –≤ main.py
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ JWT —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `validate_widget_origin()`
- –†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

**–ê–≤—Ç–æ—Ä**: Claude Code Assistant  
**–î–∞—Ç–∞**: 2025-09-05  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã