# ะัะบะพะฒะพะดััะฒะพ ะฟะพ ัะฐะทะฒะตัััะฒะฐะฝะธั ReplyX ะฒ ะฟัะพะดะฐะบัะตะฝะต

## ๐ข ะกัะฐััั ะณะพัะพะฒะฝะพััะธ ะบ ะฟัะพะดะฐะบัะตะฝั

โ **CORS ะฑะตะทะพะฟะฐัะฝะพััั** - ะกััะพะณะธะต CORS ะฝะฐัััะพะนะบะธ ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ  
โ **ะะธะผะธัั ัะตััััะพะฒ** - ะะณัะฐะฝะธัะตะฝะธั ะฟะฐะผััะธ ะธ CPU ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ  
โ **ะกััะพะณะธะต ัะตะณะธ ะพะฑัะฐะทะพะฒ** - ะัะฟะพะปัะทะพะฒะฐะฝะธะต ${TAG} ะฒะผะตััะพ :latest  
โ **ะัะพะฒะตัะบะธ ะทะดะพัะพะฒัั** - ะะพะฝะธัะพัะธะฝะณ ัะพััะพัะฝะธั ะฒัะตั ัะตัะฒะธัะพะฒ  
โ **ะะทะพะปััะธั ัะตัะตะน** - ะะทะพะปะธัะพะฒะฐะฝะฝัะต Docker ัะตัะธ  
โ **ะะฐะณะพะปะพะฒะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ** - CSP, HSTS, X-Frame-Options, X-XSS-Protection  
โ **ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฝัะต ัะฑะพัะบะธ** - ะฃะปัััะตะฝะฝัะต .dockerignore ัะฐะนะปั  
โ **ะกะบะฐะฝะธัะพะฒะฐะฝะธะต ะฑะตะทะพะฟะฐัะฝะพััะธ** - Trivy ะฟัะพะฒะตัะบะธ ะฒ CI/CD  
โ **ะะฝะตัะฝัั ะฑะฐะทะฐ ะดะฐะฝะฝัั** - PostgreSQL ะฝะฐ ะพัะดะตะปัะฝะพะผ ัะตัะฒะตัะต (192.168.0.4)

## ๐ ะััััะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต

**ะะะะะ**: ะขะตะฟะตัั ะพะฑัะทะฐัะตะปัะฝะฐ ะฟะตัะตะผะตะฝะฝะฐั TAG!

```bash
# 1. ะฃััะฐะฝะพะฒะธัั ะฟะตัะตะผะตะฝะฝัั ัะตะณะฐ (ะะะฏะะะขะะะฌะะ!)
export TAG=v1.0.0

# 2. ะะฐะฟัััะธัั ัะฐะทะฒะตัััะฒะฐะฝะธะต
cd Deployed/
chmod +x deploy.sh
./deploy.sh
```

## ๐ ะัะธัะธัะตัะบะธะต ะธะทะผะตะฝะตะฝะธั

### ๐ ะะฑะฝะพะฒะปะตะฝะธั Docker Compose
- **ะขะตะณะธ ะพะฑัะฐะทะพะฒ**: ะัะต ะพะฑัะฐะทั ัะตะฟะตัั ะธัะฟะพะปัะทััั `ghcr.io/yourorg/replyx-*:${TAG}`
- **ะะธะผะธัั ัะตััััะพะฒ**: ะะตััะบะธะต ะพะณัะฐะฝะธัะตะฝะธั ะฟะฐะผััะธ ะธ CPU
- **ะัะพะฒะตัะบะธ ะทะดะพัะพะฒัั**: ะะพะฑะฐะฒะปะตะฝั ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ
- **ะกะตัะธ**: ะัะฑะปะธัะฝะฐั ะธ ะฒะฝัััะตะฝะฝัั ะธะทะพะปััะธั

### โ๏ธ ะัะธัะธัะตัะบะธะต ะธะทะผะตะฝะตะฝะธั
1. **ะะฑัะทะฐัะตะปัะฝะฐั ะฟะตัะตะผะตะฝะฝะฐั TAG**: ะะตะพะฑัะพะดะธะผะฐ ะฟะตัะตะผะตะฝะฝะฐั `$TAG` ะฟะตัะตะด ะทะฐะฟััะบะพะผ
2. **ะะฝะตัะฝัั ะฑะฐะทะฐ ะดะฐะฝะฝัั**: ะะฐะทะฐ ะดะฐะฝะฝัั ัะถะต ะฝะฐัััะพะตะฝะฐ ะฝะฐ ะฒะฝะตัะฝะตะผ ัะตัะฒะตัะต
3. **ะััะธัะตะบัััะฐ ัะตัะตะน**: ะะทะผะตะฝะตะฝะฐ ััััะบัััะฐ ัะตัะตะน

## โ๏ธ ะะพะฝัะธะณััะฐัะธั ะพะบััะถะตะฝะธั

### ๐ ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต ะฝะฐัััะพะนะบะฐะผะธ
- **ะะดะธะฝัะน ัะฐะนะป ะบะพะฝัะธะณััะฐัะธะธ**: `Deployed/.env.production`
- **ะัะต ัะตัะฒะธัั** (backend, workers, redis) ะธัะฟะพะปัะทััั ะพะดะธะฝ ัะฐะนะป ัะตัะตะท `env_file`
- **Frontend** ะธัะฟะพะปัะทัะตั ัะพะปัะบะพ NEXT_PUBLIC_ ะฟะตัะตะผะตะฝะฝัะต ัะตัะตะท `environment`
- **ะฃะดะฐะปะตะฝั ะดัะฑะปะธััััะธะต** `.env.example` ัะฐะนะปั ะธะท ะฟะฐะฟะพะบ ัะตัะฒะธัะพะฒ

### ๐ ะะฐะบ ัะฐะฑะพัะฐะตั ะบะพะฝัะธะณััะฐัะธั:
```yaml
# docker-compose.yml
backend:
  env_file: .env.production  # ะะฐะณััะถะฐะตั ะะกะ ะฟะตัะตะผะตะฝะฝัะต

workers:  
  env_file: .env.production  # ะขะพั ะถะต ัะฐะนะป

frontend:
  environment:              # ะขะพะปัะบะพ ะฟัะฑะปะธัะฝัะต ะฟะตัะตะผะตะฝะฝัะต
    - NEXT_PUBLIC_API_URL=https://replyx.ru
```

## ๐ง ะะฐัะฟัะตะดะตะปะตะฝะธะต ัะตััััะพะฒ

```
ะะฑัะฐั ะฟะฐะผััั: ~3ะะ
ะะฑัะธะน CPU: ~2.5 ัะดัะฐ

โโโโโโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโโโโโ
โ ะกะตัะฒะธั      โ ะะฐะผััั  โ CPU     โ ะะพัั         โ
โโโโโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโโโโโค
โ Backend     โ 1024ะะ  โ 1.0     โ 8000         โ
โ Frontend    โ 512ะะ   โ 0.5     โ 3000         โ
โ Workers     โ 768ะะ   โ 0.75    โ 8443, 3002   โ
โ Redis       โ 512ะะ   โ 0.25    โ 6379         โ
โ Nginx       โ 256ะะ   โ 0.25    โ 80, 443      โ
โโโโโโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโโโโโ
```

## ๐๏ธ ะะพะฝัะธะณััะฐัะธั ะฑะฐะทั ะดะฐะฝะฝัั (ะฒะฝะตัะฝัั)

**ะะะกะขะะะะะ**: ะะฐะทะฐ ะดะฐะฝะฝัั ัะถะต ะฝะฐัััะพะตะฝะฐ!
```
ะฅะพัั: 192.168.0.4
ะะพัั: 5432
ะะฐะทะฐ ะดะฐะฝะฝัั: replyx_production
ะะพะปัะทะพะฒะฐัะตะปั: gen_user
ะะฐัะพะปั: [ะะะกะขะะะะ ะ .env.production]
SSL ัะตะถะธะผ: require
```

โ **ะะ ะทะฐะฟััะบะฐะนัะต init-db.sh** - ะฑะฐะทะฐ ัะถะต ะฝะฐัััะพะตะฝะฐ ะฝะฐ ะฒะฝะตัะฝะตะผ ัะตัะฒะตัะต!

## ๐ฆ ะััะธัะตะบัััะฐ ัะตัะตะน

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            ะัะฑะปะธัะฝะฐั ัะตัั               โ
โ         (172.20.0.0/24)                โ
โ                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ         Nginx (80/443)              โโ
โ  โ    SSL + ะะฐะณะพะปะพะฒะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ     โโ
โ  โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
โโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          ะะฝัััะตะฝะฝัั ัะตัั                โ
โ         (172.21.0.0/24)                โ
โ                โ                        โ
โ  โโโโโโโฌโโโโโโโโผโโโโโโโโโฌโโโโโโโโโ      โ
โ  โ     โ       โ        โ        โ      โ
โโโโผโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโผโโโ   โ
โโFrontโโโโBack  โโโWorkersโโโ Redis  โ   โ
โโ:3000โโโ:8000 โโโ:8443  โโโ :6379  โ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโดโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโโโโโ
                 โ
         โโโโโโโโโผโโโโโโโโโ
         โ ะะฝะตัะฝัั ะะ     โ
         โ192.168.0.4:5432โ
         โโโโโโโโโโโโโโโโโโ
```

## ๐ ะกัะฐััั ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั

### โ ะะพัะพะฒะพ ะบ ะฟัะพะดะฐะบัะตะฝั:
- โ SECRET_KEY: `QwGNF...` (32+ ัะธะผะฒะพะปะฐ)
- โ JWT_SECRET_KEY: `exF6Z...` (32+ ัะธะผะฒะพะปะฐ) 
- โ DATABASE_URL: ะะฝะตัะฝัั PostgreSQL ะฝะฐัััะพะตะฝะฐ
- โ REDIS_PASSWORD: `EGpdW...` (ัะปะพะถะฝัะน)
- โ OPENAI_API_KEY: `sk-proj...` (ะฝะฐัััะพะตะฝ ั ะฟัะพะบัะธ)
- โ TELEGRAM_BOT_TOKEN: `8088014627:AAG4...`
- โ YANDEX_SMTP: ะะฐัััะพะตะฝ ั ะฟะฐัะพะปะตะผ ะฟัะธะปะพะถะตะฝะธั
- โ CORS_ORIGINS: `https://replyx.ru,https://www.replyx.ru`

### โ๏ธ ะขัะตะฑัะตั ัััะฝะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั:
- `YANDEX_CLIENT_ID`: `CHANGEME_PRODUCTION_YANDEX_CLIENT_ID`
- `YANDEX_CLIENT_SECRET`: `CHANGEME_PRODUCTION_YANDEX_CLIENT_SECRET`

### ๐ง ะะฐัััะพะนะบะฐ OAuth:
1. ะะตัะตะนะดะธัะต ะฝะฐ https://oauth.yandex.ru/
2. ะกะพะทะดะฐะนัะต ะฟัะธะปะพะถะตะฝะธะต ะดะปั `replyx.ru`
3. ะฃะบะฐะถะธัะต callback: `https://replyx.ru/api/auth/yandex/callback`
4. ะะฑะฝะพะฒะธัะต .env.production:
   ```bash
   YANDEX_CLIENT_ID=ะฒะฐั_ัะตะฐะปัะฝัะน_client_id
   YANDEX_CLIENT_SECRET=ะฒะฐั_ัะตะฐะปัะฝัะน_client_secret
   ```

## ๐ ะัะพัะตัั ัะฐะทะฒะตัััะฒะฐะฝะธั

### ะะตัะพะด 1: ะะพะปะฝะพัััั ะฐะฒัะพะผะฐัะธัะตัะบะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต
```bash
export TAG=v1.0.0
cd Deployed/
./deploy.sh
```

### ะะตัะพะด 2: ะะพัะฐะณะพะฒะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต
```bash
export TAG=v1.0.0  # ะะะฏะะะขะะะฌะะ!
cd Deployed/

# ะัะพะฒะตัะธัั ะบะพะฝัะธะณััะฐัะธั
docker-compose config

# ะะพััะฐะฟะฝัะน ะทะฐะฟััะบ
docker-compose up -d redis
sleep 10

docker-compose up -d backend
sleep 30

docker-compose up -d workers
sleep 20

docker-compose up -d frontend
sleep 20

docker-compose up -d nginx
```

## ๐ ะขะพัะบะธ ะฟัะพะฒะตัะบะธ ะทะดะพัะพะฒัั

ะะพัะปะต ัะฐะทะฒะตัััะฒะฐะฝะธั ะฟัะพะฒะตัััะต:

```bash
# Nginx (ัะตัะตะท ะฑะฐะปะฐะฝัะธัะพะฒัะธะบ ะฝะฐะณััะทะบะธ)
curl -f https://replyx.ru/health
# ะะถะธะดะฐะตััั: "healthy"

# Backend API
curl -f https://replyx.ru/api/health
# ะะถะธะดะฐะตััั: {"status":"healthy",...}

# Frontend
curl -f https://replyx.ru/
# ะะถะธะดะฐะตััั: HTML ัััะฐะฝะธัะฐ

# Workers (ัะตัะตะท ะฒะฝัััะตะฝะฝัั ัะตัั)
docker-compose exec nginx curl -f http://workers:3002/health
# ะะถะธะดะฐะตััั: {"status":"ok",...}
```

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธ

### ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:
```bash
# ะัะพะฒะตัะธัั ััะฐััั ะฒัะตั ัะตัะฒะธัะพะฒ
docker-compose ps

# ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตััััะพะฒ
docker stats

# ะะพะณะธ ะฒัะตั ัะตัะฒะธัะพะฒ
docker-compose logs -f

# ะะพะณะธ ะบะพะฝะบัะตัะฝะพะณะพ ัะตัะฒะธัะฐ
docker-compose logs -f backend
```

### ะะฐัะฟะพะปะพะถะตะฝะธะต ะปะพะณะพะฒ:
- **ะัะธะปะพะถะตะฝะธะต**: ะะฝัััะธ ะบะพะฝัะตะนะฝะตัะพะฒ
- **Nginx**: `docker-compose logs nginx`
- **ะกะธััะตะผะฐ**: `/var/log/docker/`

## ๐ ะะตะฐะปะธะทะฐัะธั ะฑะตะทะพะฟะฐัะฝะพััะธ

### ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะทะฐะณะพะปะพะฒะบะธ:
```
Strict-Transport-Security: max-age=63072000
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' ...
```

### ะะตะทะพะฟะฐัะฝะพััั ัะตัะธ:
- ะะฝัััะตะฝะฝัั ัะตัั ะธะทะพะปะธัะพะฒะฐะฝะฐ
- ะขะพะปัะบะพ nginx ะธะผะตะตั ะฒะฝะตัะฝะธะน ะดะพัััะฟ
- ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะฐ ะพัะดะตะปัะฝะพะผ ะฒะฝะตัะฝะตะผ ัะตัะฒะตัะต
- Redis ััะตะฑัะตั ะฐััะตะฝัะธัะธะบะฐัะธะธ ะฟะพ ะฟะฐัะพะปั

### ะะธะผะธัั ัะตััััะพะฒ:
- ะัะบะปััะตะฝะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต swap (`memswap_limit = mem_limit`)
- ะะบะปััะตะฝะพ ะพะณัะฐะฝะธัะตะฝะธะต CPU
- ะะฒัะพะผะฐัะธัะตัะบะธะน ะฟะตัะตะทะฐะฟััะบ ะฟัะธ ัะฑะพัั
- ะะพะดะดะตัะถะบะฐ ะบะพััะตะบัะฝะพะณะพ ะทะฐะฒะตััะตะฝะธั

## ๐จ ะฃัััะฐะฝะตะฝะธะต ะฝะตะฟะพะปะฐะดะพะบ

### ะงะฐัััะต ะฟัะพะฑะปะตะผั ะฟะพัะปะต ะพะฑะฝะพะฒะปะตะฝะธะน:

1. **ะะตัะตะผะตะฝะฝะฐั TAG ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ**:
   ```
   ERROR: Invalid interpolation format for "image" option
   ```
   ะะตัะตะฝะธะต: `export TAG=v1.0.0`

2. **ะะพะฝัะปะธะบัั ัะตัะตะน**:
   ```bash
   # ะฃะดะฐะปะธัั ะบะพะฝัะปะธะบััััะธะต ัะตัะธ
   docker network prune
   ```

3. **ะะณัะฐะฝะธัะตะฝะธั ัะตััััะพะฒ**:
   ```bash
   # ะัะพะฒะตัะธัั ะดะพัััะฟะฝัั ะฟะฐะผััั ะฝะฐ ัะตัะฒะตัะต
   free -h
   # ะะพะปะถะฝะพ ะฑััั 4ะะ+ ะดะพัััะฟะฝะพ
   ```

4. **ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั**:
   ```bash
   # ะขะตัั ะฟะพะดะบะปััะตะฝะธั ะบ ะฒะฝะตัะฝะตะน ะะ
   docker-compose exec backend python -c "
   import psycopg2
   conn = psycopg2.connect('postgresql://gen_user:q%3F%7C%3E7!gzi%2BS.jJ@192.168.0.4:5432/replyx_production')
   print('ะะ ะฟะพะดะบะปััะตะฝะฐ!')
   "
   ```

### ะะพะผะฐะฝะดั ะดะปั ะพัะปะฐะดะบะธ:
```bash
# ะะฝัััะตะฝะฝะพััะธ ะบะพะฝัะตะนะฝะตัะพะฒ
docker-compose exec backend bash
docker-compose exec workers bash

# ะะธะฐะณะฝะพััะธะบะฐ ัะตัะตะน
docker network ls
docker network inspect replyx_public
docker network inspect replyx_internal

# ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตััััะพะฒ
docker stats --no-stream
```

## ๐ ะะฑะฝะพะฒะปะตะฝะธั ะธ ะพะฑัะปัะถะธะฒะฐะฝะธะต

### ะะฑะฝะพะฒะปะตะฝะธั ะฟัะธะปะพะถะตะฝะธั:
```bash
# ะฃััะฐะฝะพะฒะธัั ะฝะพะฒัะน ัะตะณ
export TAG=v1.1.0

# ะะพะปััะธัั ะฟะพัะปะตะดะฝะธะต ะพะฑัะฐะทั (ะตัะปะธ ะธัะฟะพะปัะทััััั ะพะฑัะฐะทั ะธะท CI/CD)
docker-compose pull

# ะะตัะตัะพะทะดะฐัั ะบะพะฝัะตะนะฝะตัั ั ะฝะพะฒัะผะธ ะพะฑัะฐะทะฐะผะธ
docker-compose up -d
```

### ะะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั:
```bash
# ะะฐะฟัััะธัั ะผะธะณัะฐัะธะธ ะฝะฐ ะฒะฝะตัะฝะตะน ะะ
docker-compose exec backend alembic upgrade head
```

## ๐ ะญะบัััะตะฝะฝัะต ะฟัะพัะตะดััั

### ะััััะพะต ะพัะบะปััะตะฝะธะต:
```bash
docker-compose down
```

### ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะฐ:
```bash
# ะะตัะตะทะฐะฟััะบ ะพะดะฝะพะณะพ ัะตัะฒะธัะฐ
docker-compose restart backend

# ะะตัะตะทะฐะฟััะบ ะฒัะตั ัะตัะฒะธัะพะฒ
docker-compose restart
```

### ะัะบะฐั:
```bash
# ะัะบะฐั ะบ ะฟัะตะดัะดััะตะผั ัะตะณั
export TAG=v1.0.0
docker-compose up -d
```

---

**๐ ะงะตะบ-ะปะธัั ัะฐะทะฒะตัััะฒะฐะฝะธั:**
- [ ] ะะตัะตะผะตะฝะฝะฐั TAG ัััะฐะฝะพะฒะปะตะฝะฐ
- [ ] .env.production ะฟัะพะฒะตัะตะฝ
- [ ] ะะฝะตัะฝัั ะฑะฐะทะฐ ะดะฐะฝะฝัั ะดะพัััะฟะฝะฐ
- [ ] DNS ะดะพะผะตะฝะฐ ะฝะฐัััะพะตะฝ
- [ ] SSL ัะตััะธัะธะบะฐัั ะณะพัะพะฒั
- [ ] Yandex OAuth ะฝะฐัััะพะตะฝ
- [ ] ะัะต ะฟัะพะฒะตัะบะธ ะทะดะพัะพะฒัั ะฟัะพะนะดะตะฝั