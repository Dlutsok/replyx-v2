# üìß –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ –° –û–¢–ü–†–ê–í–ö–û–ô –ß–ï–ö–û–í –ü–†–ò –†–ê–ó–ù–´–• –°–ü–û–°–û–ë–ê–• –û–ü–õ–ê–¢–´

**–î–∞—Ç–∞:** 11 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê –ò –ò–°–ü–†–ê–í–õ–ï–ù–ê  
**–í–µ—Ä—Å–∏—è:** 2.0 (–û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø)

---

## üö® –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï –ü–†–û–ë–õ–ï–ú–´

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π —á–µ–∫–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º –Ω–∞ email, –∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ TP (Tinkoff Pay) –∏ –°–ë–ü (–±—ã—Å—Ç—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–∏) —á–µ–∫–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

**–û–°–ù–û–í–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `OperationInitiatorType` –¥–ª—è –°–ë–ü –∏ T-Pay –ø–ª–∞—Ç–µ–∂–µ–π.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `OperationInitiatorType: 'Customer'` –≤ Init –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –°–ë–ü/T-Pay –ø–ª–∞—Ç–µ–∂–µ–π.

---

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. –°–¢–†–£–ö–¢–£–†–ê –ü–õ–ê–¢–ï–ñ–ù–û–ô –°–ò–°–¢–ï–ú–´

–í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Tinkoff API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π —Å —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:

- **Backend API:** `/api/payments/create-payment` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- **Webhook:** `/api/payments/tinkoff-notification` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **Receipt —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ:** –û–±—ä–µ–∫—Ç `Receipt` –≤ Init –∑–∞–ø—Ä–æ—Å–µ –¥–ª—è 54-–§–ó
- **Email —Å–∏—Å—Ç–µ–º–∞:** –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 2. –ê–ù–ê–õ–ò–ó –ö–û–î–ê

#### üìß Email –ª–æ–≥–∏–∫–∞ (–†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û)
```python
# –í create_payment:
user_email = email or current_user.email  # Fallback –Ω–∞ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
payment.customer_email = user_email       # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
```

#### üìÑ Receipt —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–ë–´–õ–ê –ü–†–û–ë–õ–ï–ú–ê)
```python
# –ë–´–õ–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
receipt = {
    'PaymentMethod': 'advance',     # ‚ùå –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
    'PaymentObject': 'service',     # ‚úÖ –£—Å–ª—É–≥–∞ - –ø—Ä–∞–≤–∏–ª—å–Ω–æ
}

# –°–¢–ê–õ–û (–ü–†–ê–í–ò–õ–¨–ù–û):
receipt = {
    'PaymentMethod': 'full_payment', # ‚úÖ –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–ø–æ—Å–æ–±–æ–≤
    'PaymentObject': 'service',      # ‚úÖ –£—Å–ª—É–≥–∞ - –ø—Ä–∞–≤–∏–ª—å–Ω–æ
}
```

### 3. –ö–û–†–ï–ù–¨ –ü–†–û–ë–õ–ï–ú–´

#### üè¶ –†–∞–∑–ª–∏—á–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ Tinkoff –¥–ª—è —Ä–∞–∑–Ω—ã—Ö PaymentMethod:

1. **`PaymentMethod: "advance"` (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞):**
   - –°–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç —ç—Ç–æ —á–∞—Å—Ç–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–æ–π
   - –ß–µ–∫ –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –¢—Ä–µ–±—É–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –æ–ø–ª–∞—Ç—ã

2. **`PaymentMethod: "full_payment"` (–ø–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç):**
   - –°–∏—Å—Ç–µ–º–∞ –ø–æ–Ω–∏–º–∞–µ—Ç —á—Ç–æ —ç—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞
   - –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º 54-–§–ó –¥–ª—è –≤—Å–µ—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã

#### üí≥ –ü–æ—á–µ–º—É –∫–∞—Ä—Ç–æ—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞–ª–∏:
–í–µ—Ä–æ—è—Ç–Ω–æ, Tinkoff –∏–º–µ–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –∫–∞—Ä—Ç–æ—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π, –∫–æ—Ç–æ—Ä–∞—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç `PaymentMethod: "advance"` –∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ–∫–∏. –ù–æ –¥–ª—è TP –∏ –°–ë–ü —ç—Ç–∞ –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–æ–∂–µ.

---

## ‚úÖ –í–ù–ï–°–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PaymentMethod
```python
# –§–∞–π–ª: backend/api/tinkoff_payments.py
# –°—Ç—Ä–æ–∫–∏: 449-450

# –ë–´–õ–û:
'PaymentMethod': 'advance',  # –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–¥–ª—è T-Pay/–°–ë–ü)

# –°–¢–ê–õ–û:
'PaymentMethod': 'full_payment',  # –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç (–¥–ª—è –≤—Å–µ—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã)
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```python
# –°—Ç—Ä–æ–∫–∏: 470-471

# –ë–´–õ–û:
logger.info(f"   üí∞ PaymentMethod: advance (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞)")

# –°–¢–ê–õ–û:
logger.info(f"   üí∞ PaymentMethod: full_payment (–ø–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç)")
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞:**
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç—É
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ TP
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –°–ë–ü
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —á–µ–∫–æ–≤ –Ω–∞ email

2. **–ü—Ä–æ–¥–∞–∫—à–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∂–∞–ª–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–æ—Å—Ç–∞–≤–∫–∏ —á–µ–∫–æ–≤

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç—ã, TP, –°–ë–ü) –¥–æ–ª–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ–∫–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º –Ω–∞ email.

---

## üìã –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ–∫–æ–≤
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–æ–≤:
```python
# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ webhook
logger.info(f"üìß –ß–µ–∫ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order_id} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {payment.customer_email}")
```

### 2. Fallback –¥–ª—è email
–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–ø–æ–ª–Ω–µ–Ω email:
```python
if not user_email:
    logger.error(f"‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {current_user.id} –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç email –¥–ª—è —á–µ–∫–∞!")
    # –ú–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å email –≤ UI –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂
```

### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –µ—Å–ª–∏ —á–µ–∫–∏ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∂–∞–ª–æ–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º
- –î–∞—à–±–æ—Ä–¥ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —á–µ–∫–æ–≤

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è PaymentMethod (54-–§–ó):
- `full_payment` - –ø–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç ‚úÖ (–∏—Å–ø–æ–ª—å–∑—É–µ–º)
- `advance` - –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Å—Ç–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
- `partial_prepayment` - —á–∞—Å—Ç–∏—á–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
- `credit` - –∫—Ä–µ–¥–∏—Ç
- `credit_payment` - –æ–ø–ª–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–∞

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è PaymentObject:
- `service` - —É—Å–ª—É–≥–∞ ‚úÖ (–∏—Å–ø–æ–ª—å–∑—É–µ–º)
- `commodity` - —Ç–æ–≤–∞—Ä
- `work` - —Ä–∞–±–æ—Ç–∞
- `gambling_bet` - —Å—Ç–∞–≤–∫–∞ –≤ –∞–∑–∞—Ä—Ç–Ω–æ–π –∏–≥—Ä–µ
- –∏ –¥—Ä.

---

## üìä –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞** –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –æ–¥–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `PaymentMethod` —Å `"advance"` –Ω–∞ `"full_payment"`.

–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç–æ–º—É, —á—Ç–æ —á–µ–∫–∏ –±—É–¥—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º –ø—Ä–∏ –≤—Å–µ—Ö —Å–ø–æ—Å–æ–±–∞—Ö –æ–ø–ª–∞—Ç—ã: –∫–∞—Ä—Ç–∞—Ö, Tinkoff Pay –∏ –°–ë–ü.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ
