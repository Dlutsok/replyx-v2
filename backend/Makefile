# ChatAI MVP Backend Utilities Makefile
# –£–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

.PHONY: help test snapshot db-status db-cleanup db-monitor install-deps

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å
help:
	@echo "üîß ChatAI MVP Backend Utilities"
	@echo "=================================="
	@echo ""
	@echo "üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:"
	@echo "  make test           - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ unit-—Ç–µ—Å—Ç—ã"
	@echo "  make test-db        - –¢–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
	@echo "  make test-api       - –¢–µ—Å—Ç—ã API endpoints"
	@echo "  make test-utils     - –¢–µ—Å—Ç—ã —É—Ç–∏–ª–∏—Ç –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏"
	@echo "  make test-verbose   - –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –≤—ã–≤–æ–¥–æ–º"
	@echo "  make snapshot       - –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π snapshot —Å–∏—Å—Ç–µ–º—ã"
	@echo "  make db-status      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î"
	@echo ""
	@echo "üóÑÔ∏è –ë–ê–ó–ê –î–ê–ù–ù–´–•:"
	@echo "  make db-cleanup     - –û—á–∏—Å—Ç–∏—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î"
	@echo "  make db-monitor     - –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã"
	@echo "  make db-vacuum      - –í—ã–ø–æ–ª–Ω–∏—Ç—å VACUUM –∏ ANALYZE"
	@echo ""
	@echo "üõ†Ô∏è –†–ê–ó–†–ê–ë–û–¢–ö–ê:"
	@echo "  make install-deps   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤"
	@echo "  make clean          - –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo "  make format         - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
install-deps:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
	pip install pytest psutil
	@echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
test: install-deps
	@echo "üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö unit-—Ç–µ—Å—Ç–æ–≤..."
	python3 -m pytest testing/tests/ -v

# –¢–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
test-db: install-deps
	@echo "üóÑÔ∏è –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
	python3 -m pytest testing/tests/test_database_integrity.py -v

# –¢–µ—Å—Ç—ã API endpoints
test-api: install-deps
	@echo "üåê –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ API..."
	python3 -m pytest testing/tests/test_api_endpoints.py -v

# –¢–µ—Å—Ç—ã —É—Ç–∏–ª–∏—Ç –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
test-utils: install-deps
	@echo "üõ†Ô∏è –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —É—Ç–∏–ª–∏—Ç..."
	python3 -m pytest testing/tests/test_utilities.py -v

# –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –≤—ã–≤–æ–¥–æ–º –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
test-verbose: install-deps
	@echo "üîç –ó–∞–ø—É—Å–∫ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
	python3 -m pytest testing/tests/ -v -s --tb=long

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ snapshot —Å–∏—Å—Ç–µ–º—ã
snapshot:
	@echo "üì∏ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ snapshot..."
	python3 testing/create_system_snapshot.py
	@echo "‚úÖ Snapshot —Å–æ–∑–¥–∞–Ω"

# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î
db-status:
	@echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
	@psql -U dan -d chat_ai -c "\
		SELECT \
			schemaname, \
			relname as table_name, \
			n_live_tup as live_rows, \
			n_dead_tup as dead_rows \
		FROM pg_stat_user_tables \
		WHERE n_live_tup > 0 \
		ORDER BY n_live_tup DESC;"

# –û—á–∏—Å—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î
db-cleanup:
	@echo "üßπ –ó–∞–ø—É—Å–∫ –æ—á–∏—Å—Ç–∫–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ë–î..."
	python3 testing/cleanup_database.py

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
db-monitor:
	@echo "üìà –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤..."
	@echo "=== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ==="
	@psql -U dan -d chat_ai -c "\
		SELECT \
			COUNT(*) as total_users, \
			COUNT(CASE WHEN last_activity > NOW() - INTERVAL '30 days' THEN 1 END) as active_last_30d \
		FROM users;"
	@echo ""
	@echo "=== AI –¢–û–ö–ï–ù–´ ==="
	@psql -U dan -d chat_ai -c "\
		SELECT \
			name, \
			current_daily_usage, \
			daily_limit, \
			ROUND((current_daily_usage * 100.0 / daily_limit), 2) as usage_percent \
		FROM ai_token_pool;"
	@echo ""
	@echo "=== –ê–ö–¢–ò–í–ù–û–°–¢–¨ –ó–ê 7 –î–ù–ï–ô ==="
	@psql -U dan -d chat_ai -c "\
		SELECT \
			DATE(started_at) as date, \
			COUNT(*) as dialogs, \
			COUNT(DISTINCT user_id) as unique_users \
		FROM dialogs \
		WHERE started_at > NOW() - INTERVAL '7 days' \
		GROUP BY DATE(started_at) \
		ORDER BY date DESC;"

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î
db-vacuum:
	@echo "üîß –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ VACUUM –∏ ANALYZE..."
	@echo "VACUUM; ANALYZE;" | psql -U dan -d chat_ai
	@echo "‚úÖ VACUUM –∏ ANALYZE –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.log" -delete 2>/dev/null || true
	find . -type f -name "database_snapshot_*.json" -delete 2>/dev/null || true
	find . -type f -name "system_snapshot_*.json" -delete 2>/dev/null || true
	find . -type f -name "system_summary_*.json" -delete 2>/dev/null || true
	@echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç black)
format:
	@echo "üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
	@if command -v black >/dev/null 2>&1; then \
		black *.py tests/ --line-length 100; \
		echo "‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω"; \
	else \
		echo "‚ö†Ô∏è Black –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install black"; \
	fi

# –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
diagnostic: db-status
	@echo ""
	@echo "üîç –ë–´–°–¢–†–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´"
	@echo "==============================="
	@echo ""
	@echo "üìä –°–í–û–î–ö–ê:"
	@echo -n "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: "
	@if psql -U dan -d chat_ai -c "SELECT 1;" >/dev/null 2>&1; then echo "‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞"; else echo "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞"; fi
	@echo -n "Python: "; python --version
	@echo -n "Pytest: "; python -c "import pytest; print(f'‚úÖ {pytest.__version__}')" 2>/dev/null || echo "‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
	@echo -n "Git —Å—Ç–∞—Ç—É—Å: "; git status --porcelain | wc -l | awk '{if($$1==0) print "‚úÖ –ß–∏—Å—Ç—ã–π"; else print "‚ö†Ô∏è " $$1 " –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"}'
	@echo ""

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
report: test-verbose snapshot db-monitor
	@echo ""
	@echo "üìã –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –°–û–ó–î–ê–ù!"
	@echo "======================="
	@echo "‚úÖ Unit-—Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
	@echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π snapshot —Å–æ–∑–¥–∞–Ω"
	@echo "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã"
	@echo ""
	@echo "üìÅ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
	@ls -la system_snapshot_*.json system_summary_*.json 2>/dev/null || echo "–ù–µ—Ç snapshot —Ñ–∞–π–ª–æ–≤"

# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–º–æ—â—å
.DEFAULT_GOAL := help