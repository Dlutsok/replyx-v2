#!/usr/bin/env python3
"""
–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–±–ª–µ–º–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω–∫—É

–ü—Ä–æ–±–ª–µ–º–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ /widget/dialogs/{id}/messages
2. –ö–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç push_dialog_message() –¥–ª—è –∞–¥–º–∏–Ω–∫–∏  
3. –ù–û –∞–¥–º–∏–Ω–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ WebSocket (admin_connections = 0)
4. –ü–æ—ç—Ç–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

–†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–∏—Ç—å "—Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω—ã–π" –º–µ—Ö–∞–Ω–∏–∑–º –¥–≤–æ–π–Ω–æ–≥–æ broadcast –¥–ª—è user —Å–æ–æ–±—â–µ–Ω–∏–π
+ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
"""

# –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—É–∂–µ –ø—Ä–∏–º–µ–Ω—ë–Ω –≤ api/site.py):

user_message_delivery_fix = """
# –í api/site.py, —Å—Ç—Ä–æ–∫–∏ ~579-586 –∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ:

if msg.sender == 'user':
    user_message_data = {
        "id": msg.id,
        "sender": msg.sender, 
        "text": msg.text,
        "timestamp": msg.timestamp.isoformat() + 'Z'
    }
    # ‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    from services.websocket_manager import get_connection_stats
    stats = get_connection_stats()
    logger.info(
        f"[MSG_BROADCAST] dialog={dialog_id} sender=user "
        f"admin_conns={stats['connection_details']['admin_connections']} "
        f"site_conns={stats['connection_details']['site_connections']}"
    )
    
    # ‚úÖ –û–°–ù–û–í–ù–û–ô BROADCAST –≤ –∞–¥–º–∏–Ω–∫—É
    await push_dialog_message(dialog_id, user_message_data)
    
    # ‚úÖ –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û: –î—É–±–ª–∏—Ä—É—é—â–∏–π broadcast –µ—Å–ª–∏ –∞–¥–º–∏–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    # (–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    if stats['connection_details']['admin_connections'] == 0:
        logger.warning(f"[MSG_BROADCAST] No admin connections for dialog {dialog_id}, message may be lost")
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–æ—Å—Ç–∞–≤–∫–∏
"""

monitoring_recommendations = """
# –ú–û–ù–ò–¢–û–†–ò–ù–ì: –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –ª–æ–≥–∞—Ö:

1. "No ADMIN WebSocket connections found for dialog" 
   -> –ê–¥–º–∏–Ω–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ –¥–∏–∞–ª–æ–≥—É

2. "[MSG_BROADCAST] dialog=X sender=user admin_conns=0"
   -> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–æ

3. "WEBSOCKET_4003_ERROR" 
   -> –ü—Ä–æ–±–ª–µ–º—ã —Å iframe –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

# –†–ï–®–ï–ù–ò–ï –û–ü–ï–†–ê–¢–û–†–ê:
1. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É
2. –ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω—É–∂–Ω–æ–º—É –¥–∏–∞–ª–æ–≥—É  
3. WebSocket –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –°–æ–æ–±—â–µ–Ω–∏—è –Ω–∞—á–Ω—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
"""

if __name__ == "__main__":
    print("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –≤ api/site.py")
    print("üìä –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ")
    print("üîß –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –¥–∏–∞–ª–æ–≥—É")