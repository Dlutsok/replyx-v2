"""
Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ² Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğµ
Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… ÑĞ»Ğ¾Ğ² Ğ½Ğ° Ğ±Ğ¾Ğ»ĞµĞµ ÑƒĞ¼Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·
"""

import re
from typing import Tuple, List, Dict
from dataclasses import dataclass

@dataclass
class HandoffPattern:
    """ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"""
    pattern: str
    reason: str
    weight: float
    description: str

class ImprovedHandoffDetector:
    """Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ handoff Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ñ‹Ğ¼ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ¼"""
    
    def __init__(self):
        # ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        self.handoff_patterns = [
            # ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
            HandoffPattern(r'\bĞ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€\b(?!.{0,20}(?:if|while|for|Ğ¿Ñ€Ğ¸ÑĞ²Ğ°Ğ¸Ğ²Ğ°Ğ½Ğ¸|ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸|\+\=|\-\=|\*\=|python|javascript|java|sql|Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸))', "direct_operator", 0.9, 
                         "ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ 'Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€'"),
            HandoffPattern(r'(?:Ğ½ÑƒĞ¶ĞµĞ½|Ñ…Ğ¾Ñ‡Ñƒ|ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚Ğµ|Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ|Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¸Ñ‚Ğµ|Ğ´Ğ°Ğ¹Ñ‚Ğµ|Ğ¿Ğ¾Ğ·Ğ¾Ğ²Ğ¸Ñ‚Ğµ).{0,20}Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€', "direct_operator", 1.0, 
                         "ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"),
            HandoffPattern(r'Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€.{0,20}(?:Ğ½ÑƒĞ¶ĞµĞ½|Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°|Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ¸Ñ‚Ğµ)', "direct_operator", 1.0,
                         "ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°"),
            HandoffPattern(r'(?:Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸|Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ|Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ).{0,20}(?:Ğº|Ğ½Ğ°|Ğ¼ĞµĞ½Ñ).{0,20}Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€', "direct_operator", 1.0,
                         "ĞŸÑ€Ğ¾ÑÑŒĞ±Ğ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğº Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ"),
            HandoffPattern(r'(?:Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ|Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ|Ğ¼Ğ¾Ğ´ĞµÑˆÑŒ).{0,20}(?:Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ|ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒ).{0,20}(?:Ñ|Ğº|Ğ½Ğ°|Ğ¼ĞµĞ½Ñ).{0,20}Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€', "direct_operator", 1.0,
                         "Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğº Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ"),
            
            # Ğ–Ğ¸Ğ²Ğ¾Ğ¹ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº
            HandoffPattern(r'(?:Ğ½ÑƒĞ¶ĞµĞ½|Ñ…Ğ¾Ñ‡Ñƒ|ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚Ğµ).{0,20}(?:Ğ¶Ğ¸Ğ²Ğ¾Ğ³Ğ¾|Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾).{0,10}Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº', "human_request", 1.0,
                         "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¶Ğ¸Ğ²Ğ¾Ğ³Ğ¾ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°"),
            HandoffPattern(r'(?:Ğ¶Ğ¸Ğ²Ğ¾Ğ¹|Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹) Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº', "human_request", 0.9,
                         "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¶Ğ¸Ğ²Ğ¾Ğ³Ğ¾ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°"),
            HandoffPattern(r'(?:Ñ…Ğ¾Ñ‡Ñƒ|Ğ½ÑƒĞ¶Ğ½Ğ¾).{0,30}Ñ (?:Ğ¶Ğ¸Ğ²Ñ‹Ğ¼|Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼) Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ğ¼', "human_request", 0.9,
                         "Ğ Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ñ Ğ¶Ğ¸Ğ²Ñ‹Ğ¼ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ğ¼"),
            HandoffPattern(r'(?:Ğ¼Ğ¾Ğ¶Ğ½Ğ¾|Ğ´Ğ°Ğ¹Ñ‚Ğµ|Ğ¿Ğ¾Ğ·Ğ¾Ğ²Ğ¸Ñ‚Ğµ).{0,20}Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°', "human_request", 0.9,
                         "ĞŸÑ€Ğ¾ÑÑŒĞ±Ğ° Ğ¿Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°"),
            HandoffPattern(r'Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°.{0,10}(?:Ğ¼Ğ¾Ğ¶Ğ½Ğ¾|Ğ´Ğ°Ğ¹Ñ‚Ğµ|Ğ¿Ğ¾Ğ·Ğ¾Ğ²Ğ¸Ñ‚Ğµ)', "human_request", 0.9,
                         "ĞŸÑ€Ğ¾ÑÑŒĞ±Ğ° Ğ¿Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°"),
            HandoffPattern(r'(?:Ğ½ÑƒĞ¶ĞµĞ½|Ñ…Ğ¾Ñ‡Ñƒ).{0,10}Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº', "human_request", 0.8,
                         "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°"),
            HandoffPattern(r'(?:Ñ…Ğ¾Ñ‡Ñƒ|Ğ¼Ğ¾Ğ³Ñƒ).{0,30}Ğ¿Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ.{0,20}Ñ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ğ¼', "human_request", 0.9,
                         "Ğ–ĞµĞ»Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ñ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ğ¼"),
            
            # ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ (Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼)
            HandoffPattern(r'(?:ÑĞ»ÑƒĞ¶Ğ±Ğ°|Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ|Ñ‚ĞµÑ…).{0,10}Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°', "support_request", 0.8,
                         "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ»ÑƒĞ¶Ğ±Ñ‹ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸"),
            HandoffPattern(r'Ğ¾Ğ±Ñ€Ğ°Ñ‚.{0,15}Ğ².{0,10}(?:ÑĞ»ÑƒĞ¶Ğ±Ñƒ.{0,10})?Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğº', "support_request", 0.9,
                         "ĞĞ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ"),
            HandoffPattern(r'(?:ÑĞµÑ€ÑŒĞµĞ·Ğ½Ğ°Ñ|ÑÑ€Ğ¾Ñ‡Ğ½Ğ°Ñ|Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ).{0,10}Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ', "help_request", 0.8,
                         "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞµÑ€ÑŒĞµĞ·Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸"),
            
            # ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€
            HandoffPattern(r'(?:Ğ½ÑƒĞ¶ĞµĞ½|Ñ…Ğ¾Ñ‡Ñƒ|ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚Ğµ).{0,20}(?:Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€|Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»|Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸Ğº)', "manager_request", 0.9,
                         "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°"),
            
            # Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñ‹
            HandoffPattern(r'(?:Ğ½ÑƒĞ¶ĞµĞ½|Ñ…Ğ¾Ñ‡Ñƒ).{0,20}(?:ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚|ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚|ÑĞºÑĞ¿ĞµÑ€Ñ‚)', "specialist_request", 0.8,
                         "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ°"),
            
            # Ğ–Ğ°Ğ»Ğ¾Ğ±Ñ‹
            HandoffPattern(r'(?:Ñ…Ğ¾Ñ‡Ñƒ|Ğ¿Ğ¾Ğ´Ğ°Ñ‚ÑŒ|ĞµÑÑ‚ÑŒ).{0,20}Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñƒ?', "complaint", 0.9,
                         "ĞŸĞ¾Ğ´Ğ°Ñ‡Ğ° Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñ‹"),
            HandoffPattern(r'(?:Ğ½ĞµĞ´Ğ¾Ğ²Ğ¾Ğ»ĞµĞ½|Ğ¿Ğ»Ğ¾Ñ…Ğ¾|ÑƒĞ¶Ğ°ÑĞ½Ğ¾).{0,30}(?:ÑĞµÑ€Ğ²Ğ¸Ñ|Ğ¾Ğ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸|Ñ€Ğ°Ğ±Ğ¾Ñ‚)', "complaint", 0.8,
                         "ĞĞµĞ´Ğ¾Ğ²Ğ¾Ğ»ÑŒÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ¼"),
            
            # ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ (Ñ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼)
            HandoffPattern(r'(?:ÑĞµÑ€ÑŒĞµĞ·Ğ½Ğ°Ñ|ÑĞ»Ğ¾Ğ¶Ğ½Ğ°Ñ|Ğ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ).{0,10}Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°', "complex_problem", 0.7,
                         "Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°"),
            HandoffPattern(r'Ğ½Ğµ (?:Ğ¼Ğ¾Ğ³Ñƒ|Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ÑÑ|ÑƒĞ´Ğ°ĞµÑ‚ÑÑ) Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ', "cannot_solve", 0.8,
                         "ĞĞµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ ÑĞ°Ğ¼"),
            
            # Ğ¤Ñ€ÑƒÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
            HandoffPattern(r'(?:Ñ‚Ñ€ĞµÑ‚Ğ¸Ğ¹|Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾|Ğ¼Ğ½Ğ¾Ğ³Ğ¾) Ñ€Ğ°Ğ· (?:Ğ¿Ñ‹Ñ‚Ğ°ÑÑÑŒ|ÑĞ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ñ|Ğ¿Ñ€Ğ¾ÑˆÑƒ)', "frustration", 0.7,
                         "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸"),
            HandoffPattern(r'(?:ÑƒĞ¶Ğµ|Ğ´Ğ°Ğ²Ğ½Ğ¾) (?:Ğ¿Ñ‹Ñ‚Ğ°ÑÑÑŒ|Ğ¶Ğ´Ñƒ|Ğ¿Ñ€Ğ¾ÑˆÑƒ)', "frustration", 0.6,
                         "Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸"),
            
            # English patterns
            HandoffPattern(r'(?:need|want|connect).{0,20}(?:human|operator|agent)', "english_request", 1.0,
                         "English operator request"),
            HandoffPattern(r'speak.{0,20}(?:human|person|agent)', "english_request", 0.9,
                         "English human request"),
            HandoffPattern(r'customer (?:service|support)', "english_request", 0.8,
                         "English support request"),
        ]
        
        # Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ÑÑ‰Ğ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ (Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ)
        self.exclusion_patterns = [
            # Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ñ‹
            r'Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€.{0,20}(?:if|while|for|Ğ¿Ñ€Ğ¸ÑĞ²Ğ°Ğ¸Ğ²Ğ°Ğ½Ğ¸|ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸|\+\=|\-\=|\*\=)',
            r'(?:Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹|Ğ°Ñ€Ğ¸Ñ„Ğ¼ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹|Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ñ‹Ğ¹).{0,10}Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€',
            r'Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€.{0,20}(?:python|javascript|java|sql|Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸)',
            
            # ĞĞ±Ñ‰Ğ¸Ğµ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ñ‹
            r'Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº.{0,20}(?:Ğ¼Ğ»ĞµĞºĞ¾Ğ¿Ğ¸Ñ‚Ğ°ÑÑ‰ĞµĞµ|Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ğ¾Ğµ|ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾|Ğ²Ğ¸Ğ´|Ğ¾ÑĞ¾Ğ±ÑŒ)',
            r'Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°.{0,20}(?:Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²|Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚|Ğ²ĞµÑ€ÑĞ¸|Ñ‚ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸)',
            r'Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€.{0,20}(?:Ğ·Ğ°Ğ´Ğ°Ñ‡|Ğ¿Ğ°ĞºĞµÑ‚|Ğ¿Ñ€Ğ¾ĞµĞºÑ‚|Ñ„Ğ°Ğ¹Ğ»|memory|Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸)',
            
            # Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ¸ÑÑ…
            r'Ñ‡Ñ‚Ğ¾ (?:Ñ‚Ğ°ĞºĞ¾Ğµ|ÑÑ‚Ğ¾|Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚).{0,20}(?:Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€|Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€|Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°)',
            r'ĞºĞ°Ğº (?:Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚|Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ).{0,20}(?:Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€|Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)',
        ]
        
        # ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ´Ğ»Ñ AI fallback
        self.ai_fallback_patterns = [
            r'Ğ½Ğµ (?:Ğ¼Ğ¾Ğ³Ñƒ|ÑĞ¼Ğ¾Ğ³Ñƒ|Ğ·Ğ½Ğ°Ñ ĞºĞ°Ğº) (?:Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ|Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ|Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ)',
            r'(?:Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚|Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾) (?:Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸|Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)',
            r'Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğ² (?:Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ|ÑĞ»ÑƒĞ¶Ğ±Ñƒ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸)',
            r'(?:Ğ½Ğµ ÑƒĞ²ĞµÑ€ĞµĞ½|Ğ·Ğ°Ñ‚Ñ€ÑƒĞ´Ğ½ÑÑÑÑŒ) Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ',
            r'ÑÑ‚Ğ¾ (?:ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹|ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹|Ğ¾ÑĞ¾Ğ±Ñ‹Ğ¹) (?:Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ|ÑĞ»ÑƒÑ‡Ğ°Ğ¹)',
            r'Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒÑ (?:Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ|ÑĞ²ÑĞ·Ğ°Ñ‚ÑŒÑÑ)',
            r'(?:cannot|can\'t|unable to) (?:answer|help|solve)',
            r'(?:don\'t|do not) (?:know|have) (?:enough|sufficient)',
            r'contact (?:support|our team)',
        ]

    def should_request_handoff(self, user_text: str, ai_text: str = None, dialog=None) -> Tuple[bool, str, Dict]:
        """
        ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ½ÑƒĞ¶ĞµĞ½ Ğ»Ğ¸ handoff Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ¹ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¾Ğ¹
        
        Returns:
            Tuple[bool, str, dict]: (should_handoff, reason, details)
        """
        details = {
            "matched_patterns": [],
            "excluded_patterns": [],
            "total_score": 0.0,
            "threshold": 0.5,
            "ai_fallback": False
        }
        
        # 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ÑÑ‰Ğ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹
        user_text_clean = user_text.lower()
        for exclusion_pattern in self.exclusion_patterns:
            if re.search(exclusion_pattern, user_text_clean):
                details["excluded_patterns"].append(exclusion_pattern)
                # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½, ÑĞ½Ğ¸Ğ¶Ğ°ĞµĞ¼ Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ
                return False, "excluded_pattern", details
        
        # 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ handoff Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹
        total_score = 0.0
        for pattern in self.handoff_patterns:
            match = re.search(pattern.pattern, user_text_clean)
            if match:
                details["matched_patterns"].append({
                    "pattern": pattern.pattern,
                    "reason": pattern.reason,
                    "weight": pattern.weight,
                    "description": pattern.description,
                    "matched_text": match.group()
                })
                total_score += pattern.weight
        
        details["total_score"] = total_score
        
        # 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ AI fallback ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚ AI
        if ai_text:
            ai_text_clean = ai_text.lower()
            for fallback_pattern in self.ai_fallback_patterns:
                if re.search(fallback_pattern, ai_text_clean):
                    details["ai_fallback"] = True
                    total_score += 0.8  # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ĞµÑ Ğ·Ğ° AI fallback
                    break
        
        # 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° (Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹)
        if dialog and hasattr(dialog, 'fallback_count') and dialog.fallback_count >= 2:
            total_score += 0.6
            details["repeated_issues"] = True
        
        details["total_score"] = total_score
        
        # 5. ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ
        if total_score >= details["threshold"]:
            # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½ÑƒÑ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ
            if details.get("ai_fallback"):
                main_reason = "fallback"
            elif details.get("repeated_issues"):
                main_reason = "retries" 
            elif details["matched_patterns"]:
                main_reason = "keyword"
            else:
                main_reason = "manual"
                
            return True, main_reason, details
        
        return False, "", details

    def get_improved_keywords_for_config(self) -> Dict[str, List[str]]:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸"""
        return {
            "phrases_ru": [
                "Ğ½ÑƒĞ¶ĞµĞ½ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", "Ñ…Ğ¾Ñ‡Ñƒ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°", "ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚Ğµ Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼",
                "Ğ¶Ğ¸Ğ²Ğ¾Ğ¹ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº", "Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº", "Ğ½ÑƒĞ¶ĞµĞ½ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº",
                "ÑĞ»ÑƒĞ¶Ğ±Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸", "Ñ‚ĞµÑ…Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°", "Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ",
                "Ğ½ÑƒĞ¶ĞµĞ½ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€", "ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚Ğµ Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼",
                "Ğ½ÑƒĞ¶ĞµĞ½ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚", "ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚", "ÑĞºÑĞ¿ĞµÑ€Ñ‚",
                "Ğ¿Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñƒ", "ĞµÑÑ‚ÑŒ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ğ°", "Ğ½ĞµĞ´Ğ¾Ğ²Ğ¾Ğ»ĞµĞ½ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ¼",
                "ÑĞµÑ€ÑŒĞµĞ·Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°", "Ğ½Ğµ Ğ¼Ğ¾Ğ³Ñƒ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ", "ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ"
            ],
            "phrases_en": [
                "need operator", "human support", "connect to agent",
                "speak with human", "customer service", "need help",
                "want to complain", "serious problem"
            ],
            "exclusions": [
                "Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ if", "Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ while", "Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€",
                "Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡", "Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²", "Ñ‡Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€"
            ]
        }

def test_improved_detector():
    """Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½ÑƒÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ"""
    detector = ImprovedHandoffDetector()
    
    # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ÑĞ»ÑƒÑ‡Ğ°Ğ¸
    test_cases = [
        # Ğ”Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ
        ("Ğ½ÑƒĞ¶ĞµĞ½ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", True),
        ("ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚Ğµ Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°", True), 
        ("Ñ…Ğ¾Ñ‡Ñƒ Ğ¿Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ñ Ğ¶Ğ¸Ğ²Ñ‹Ğ¼ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ğ¼", True),
        ("Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğ² ÑĞ»ÑƒĞ¶Ğ±Ñƒ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸", True),
        ("Ñƒ Ğ¼ĞµĞ½Ñ ÑĞµÑ€ÑŒĞµĞ·Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°", True),
        ("Ğ¿Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñƒ Ğ½Ğ° ÑĞµÑ€Ğ²Ğ¸Ñ", True),
        ("Ğ½Ğµ Ğ¼Ğ¾Ğ³Ñƒ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ ÑÑ‚Ñƒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ", True),
        ("need human operator", True),
        
        # ĞĞ• Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ
        ("Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ if Ğ² Python", False),
        ("Ñ‡Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", False),
        ("Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡ Windows", False),
        ("Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² PDF", False),
        ("Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº ÑÑ‚Ğ¾ Ğ¼Ğ»ĞµĞºĞ¾Ğ¿Ğ¸Ñ‚Ğ°ÑÑ‰ĞµĞµ", False),
        ("Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼", False),
    ]
    
    print("ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢ Ğ£Ğ›Ğ£Ğ§Ğ¨Ğ•ĞĞĞĞ™ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«:")
    print("=" * 60)
    
    correct = 0
    for text, expected in test_cases:
        should_handoff, reason, details = detector.should_request_handoff(text)
        status = "âœ…" if should_handoff == expected else "âŒ"
        score = details["total_score"]
        
        print(f"{status} '{text}' -> {should_handoff} (score: {score:.2f})")
        if details["matched_patterns"]:
            for pattern in details["matched_patterns"]:
                print(f"    ğŸ“‹ {pattern['description']} (weight: {pattern['weight']})")
        if details["excluded_patterns"]:
            print(f"    ğŸš« Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½: {len(details['excluded_patterns'])} Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²")
        
        if should_handoff == expected:
            correct += 1
    
    print(f"\nğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: {correct}/{len(test_cases)} ({correct/len(test_cases)*100:.1f}%)")
    
if __name__ == "__main__":
    test_improved_detector()