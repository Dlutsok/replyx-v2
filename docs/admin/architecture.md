# Архитектура админской системы аналитики

## Обзор

Админская система аналитики ReplyX представляет собой полнофункциональный модуль для мониторинга ключевых метрик платформы. Система построена по принципам многослойной архитектуры с четким разделением ответственности.

## Архитектурная схема

```
┌─────────────────────────────────────────────────────────────────┐
│                    ADMIN ANALYTICS SYSTEM                      │
├─────────────────────────────────────────────────────────────────┤
│                    FRONTEND LAYER                              │
├─────────────────────────────────────────────────────────────────┤
│ /admin-analytics                                               │
│   ├── AdminAnalyticsHeader (фильтры периода)                   │
│   ├── OverviewMetrics (4 ключевые метрики)                     │
│   ├── AnalyticsTabs (переключение разделов)                    │
│   ├── UsersAnalyticsPanel (таблица пользователей)             │
│   ├── DialogsAnalyticsPanel (статистика диалогов)             │
│   └── RevenueAnalyticsPanel (финансовая аналитика)            │
├─────────────────────────────────────────────────────────────────┤
│                    HOOKS LAYER                                 │
├─────────────────────────────────────────────────────────────────┤
│ useAdminAnalytics                                              │
│   ├── API интеграция (4 endpoints)                            │
│   ├── Управление состоянием                                   │
│   ├── Пагинация пользователей                                 │
│   ├── Форматирование данных                                   │
│   └── Обработка ошибок                                        │
├─────────────────────────────────────────────────────────────────┤
│                    API LAYER                                   │
├─────────────────────────────────────────────────────────────────┤
│ /api/admin/analytics/*                                         │
│   ├── /overview - обзорные метрики                            │
│   ├── /users - аналитика пользователей                        │
│   ├── /dialogs - статистика диалогов                          │
│   └── /revenue - финансовая аналитика                         │
├─────────────────────────────────────────────────────────────────┤
│                    SERVICE LAYER                               │
├─────────────────────────────────────────────────────────────────┤
│ AnalyticsService                                               │
│   ├── Кэширование метрик (Redis)                             │
│   ├── Сложные SQL запросы                                     │
│   ├── Агрегация данных                                        │
│   └── Бизнес-логика расчетов                                  │
├─────────────────────────────────────────────────────────────────┤
│                    DATABASE LAYER                              │
├─────────────────────────────────────────────────────────────────┤
│ PostgreSQL Tables                                              │
│   ├── users (пользователи)                                    │
│   ├── dialogs (диалоги)                                       │
│   ├── dialog_messages (сообщения)                             │
│   ├── user_balance (балансы)                                  │
│   └── balance_transactions (транзакции)                       │
└─────────────────────────────────────────────────────────────────┘
```

## Компонентная архитектура

### Frontend компоненты

#### 1. AdminAnalyticsPage
**Расположение**: `/frontend/pages/admin-analytics.js`
**Назначение**: Основная страница админской аналитики
**Ключевые функции**:
- Управление состоянием (период, активная вкладка)
- Интеграция с useAdminAnalytics hook
- Обработка ошибок и загрузки
- Защита доступа (adminOnly)

#### 2. AdminAnalyticsHeader
**Расположение**: `/frontend/components/admin/AdminAnalyticsHeader.js`
**Назначение**: Заголовок с фильтрами
**Ключевые функции**:
- Выбор периода анализа (7d, 30d, 90d)
- Кнопка обновления данных
- Отображение времени последнего обновления

#### 3. OverviewMetrics
**Расположение**: `/frontend/components/admin/OverviewMetrics.js`
**Назначение**: Отображение 4 ключевых метрик
**Метрики**:
- Общее количество пользователей
- Активные пользователи
- Общее количество диалогов
- Общая выручка

#### 4. AnalyticsTabs
**Расположение**: `/frontend/components/admin/AnalyticsTabs.js`
**Назначение**: Навигация между разделами аналитики
**Вкладки**:
- Overview (обзор)
- Users (пользователи)
- Dialogs (диалоги)
- Revenue (выручка)

#### 5. UsersAnalyticsPanel
**Расположение**: `/frontend/components/admin/UsersAnalyticsPanel.js`
**Назначение**: Детальная аналитика пользователей
**Функции**:
- Табличное отображение пользователей
- Пагинация (20 записей на страницу)
- Сортировка по различным полям
- Поиск и фильтрация

#### 6. DialogsAnalyticsPanel
**Расположение**: `/frontend/components/admin/DialogsAnalyticsPanel.js`
**Назначение**: Статистика по диалогам
**Метрики**:
- Общее количество диалогов
- Активные диалоги
- Среднее время сессии
- Распределение по каналам

#### 7. RevenueAnalyticsPanel
**Расположение**: `/frontend/components/admin/RevenueAnalyticsPanel.js`
**Назначение**: Финансовая аналитика
**Метрики**:
- Общая выручка
- Выручка по периодам
- ARPU (средняя выручка на пользователя)
- Конверсия

### Hooks Layer

#### useAdminAnalytics
**Расположение**: `/frontend/hooks/useAdminAnalytics.js`
**Назначение**: Центральный hook для работы с данными аналитики

**Основные функции**:
```javascript
// Состояние данных
- overviewData: объект с обзорными метриками
- usersData: данные пользователей с пагинацией
- dialogsData: статистика диалогов
- revenueData: финансовые данные

// UI состояния
- isLoading: индикатор загрузки
- error: сообщение об ошибке

// Методы управления
- refreshData(): обновление данных
- handleUsersPageChange(): смена страницы пользователей
- clearError(): очистка ошибок

// Утилиты
- formatters: объект с функциями форматирования
```

**API интеграция**:
```javascript
// Четыре основных endpoint'а
- fetchOverviewData() -> /api/admin/analytics/overview
- fetchUsersData() -> /api/admin/analytics/users
- fetchDialogsData() -> /api/admin/analytics/dialogs
- fetchRevenueData() -> /api/admin/analytics/revenue
```

### Backend архитектура

#### API Endpoints

1. **GET /admin/analytics/overview**
   - **Схема**: `AdminAnalyticsOverview`
   - **Параметры**: period (day/week/month)
   - **Возвращает**: Основные метрики системы

2. **GET /admin/analytics/users**
   - **Схема**: `AdminUserAnalytics`
   - **Параметры**: page, limit, sort_by, order, period
   - **Возвращает**: Список пользователей с пагинацией

3. **GET /admin/analytics/dialogs**
   - **Схема**: `AdminDialogAnalytics`
   - **Параметры**: period
   - **Возвращает**: Статистику по диалогам

4. **GET /admin/analytics/revenue**
   - **Схема**: `AdminRevenueAnalytics`
   - **Параметры**: period (week/month/quarter/year)
   - **Возвращает**: Финансовые метрики

#### Service Layer

**AnalyticsService** (`/backend/services/analytics_service.py`):
- Кэширование часто запрашиваемых метрик (TTL: 5 минут)
- Сложные SQL агрегации
- Бизнес-логика расчета KPI

#### Схемы данных

**Pydantic схемы** (`/backend/database/schemas.py`):
```python
class AdminAnalyticsOverview(BaseModel):
    total_users: int
    active_users_today: int
    total_dialogs: int
    # ... другие поля

class AdminUserAnalytics(BaseModel):
    users: List[Dict[str, Any]]
    user_growth: Dict[str, int]
    # ... другие поля
```

## Стили и дизайн

### CSS архитектура
**Файл**: `/frontend/styles/components/AdminAnalytics.module.css`

**Принципы**:
- Модульный CSS с Tailwind CSS
- Responsive дизайн
- ReplyX фирменные цвета
- Консистентная типографика

**Основные классы**:
```css
.adminAnalyticsPage - основной контейнер
.header - заголовок с фильтрами
.tabsContainer - контейнер вкладок
.contentArea - область контента
.metricCard - карточка метрики
.chartContainer - контейнер графиков
```

## Безопасность

### Авторизация
- Страница защищена через `withAuth(AdminAnalyticsPage, { adminOnly: true })`
- Все API endpoints требуют admin роль
- JWT токен в заголовках запросов

### Валидация данных
- Pydantic схемы для всех API ответов
- Валидация параметров запросов (Query validation)
- Sanitization входящих данных

## Производительность

### Кэширование
- Redis кэш для метрик (TTL: 5 минут)
- Мемоизация сложных вычислений
- Lazy loading для больших наборов данных

### Оптимизация SQL
- Индексы для часто запрашиваемых полей
- Агрегация на уровне БД
- Пагинация для больших результатов

### Frontend оптимизации
- Debounced поиск и фильтрация
- Виртуализация длинных списков
- Предзагрузка данных соседних страниц

## Мониторинг и логирование

### Метрики
- Время ответа API endpoints
- Количество запросов к аналитике
- Ошибки и исключения

### Аудит
- Логирование доступа к админской панели
- Отслеживание изменений данных
- Мониторинг производительности запросов

## Развертывание

### Зависимости
**Backend**:
- FastAPI
- SQLAlchemy
- Redis
- Pydantic

**Frontend**:
- Next.js
- React
- Tailwind CSS
- react-icons

### Конфигурация
- Переменные окружения для подключения к БД
- Redis конфигурация
- CORS настройки для API

## Расширяемость

### Добавление новых метрик
1. Расширить соответствующую Pydantic схему
2. Обновить API endpoint
3. Добавить расчет в AnalyticsService
4. Обновить frontend компонент

### Новые разделы аналитики
1. Создать новый Panel компонент
2. Добавить API endpoint
3. Расширить useAdminAnalytics hook
4. Добавить вкладку в AnalyticsTabs

## TypeScript совместимость

Система полностью совместима с TypeScript:
- Все компоненты имеют типизацию
- API ответы типизированы
- Props и state четко определены
- Автокомплит в IDE

## Заключение

Архитектура админской системы аналитики ReplyX обеспечивает:
- Высокую производительность через кэширование
- Масштабируемость через модульную архитектуру  
- Безопасность через строгую авторизацию
- Удобство сопровождения через четкое разделение слоев
- Расширяемость через plug-and-play компоненты