# Каталог сервисов - ReplyX MVP 13

**Последнее обновление:** 14 сентября 2025 г.
**Версия:** v1.3 - Полная документация сервисов

Полный каталог всех сервисов, точек входа, зависимостей и операционных процедур для платформы ReplyX.

## 1. Backend API сервис

**Точка входа:** `backend/main.py`
**Технология:** FastAPI 0.104+ / Python 3.9+
**Порт:** 8000 (HTTP)

**Описание:** Основной backend API сервис, предоставляющий RESTful endpoints, аутентификацию, бизнес-логику и коммуникации в реальном времени.

**Ключевые компоненты:**
- 24 API модуля (auth, assistants, dialogs, documents, balance, etc.)
- JWT аутентификация с CSRF защитой
- Server-Sent Events (SSE) для обновлений в реальном времени
- Интеграция PostgreSQL + Redis
- Маршрутизация AI провайдеров и управление токенами

**Зависимости:**
- **База данных:** PostgreSQL 14+ с pgvector
- **Кэш:** Redis 6+
- **AI провайдеры:** OpenAI API, YandexGPT (опционально)
- **Внешние сервисы:** SMTP, платежные шлюзы

**Health Check:** `GET /health`
**Метрики:** `GET /metrics` (формат Prometheus)
**Документация:** `docs/api/endpoints.md`
**Runbook:** `docs/runbooks/backend.md`

**Критические файлы:**
- `core/app_config.py` - Управление конфигурацией
- `database/models.py` - ORM модели
- `services/` - Сервисы бизнес-логики
- `alembic/versions/` - Миграции базы данных

## 2. Сервис коммуникаций реального времени

**Точка входа:** `services/sse_manager.py`
**Технология:** Server-Sent Events (SSE)
**Порт:** 8000 (тот же что и backend)

**Описание:** Сервис коммуникаций в реальном времени для живых обновлений, operator handoff и системных уведомлений.

**Ключевые функции:**
- SSE подключения для диалогов и admin dashboard
- Redis Pub/Sub для межсервисных сообщений
- Совместимость с WebSocket bridge (legacy)
- Управление подключениями и мониторинг heartbeat

**События:** `docs/realtime/events.md`
**Архитектура:** `docs/realtime/sse-architecture.md`
**Руководство по миграции:** `docs/realtime/websocket-to-sse.md`

**Зависимости:**
- **Backend API:** Интеграция FastAPI lifespan
- **Redis:** Pub/Sub сообщения
- **Frontend:** EventSource подключения

## 3. Telegram Bot воркеры

**Точка входа:** `workers/master/scalable_bot_manager.js`
**Технология:** Node.js 18+ / Express.js
**Порт:** 3001 (HTTP health checks)

**Описание:** Масштабируемая система управления Telegram ботами, поддерживающая 1000+ одновременных экземпляров ботов с изоляцией процессов.

**Архитектура:**
- **Master процесс:** `scalable_bot_manager.js` - Оркестрация ботов
- **Worker процессы:** `telegram/bot_worker.js` - Отдельные экземпляры ботов
- **Изоляция процессов:** Каждый бот работает в отдельном Node.js воркере
- **Rate Limiting:** Соответствие Telegram API (30 сообщений/сек на бота)

**Функции:**
- Автоматический перезапуск воркеров при сбоях
- IPC коммуникация между master и воркерами
- Продвинутый rate limiting и очереди сообщений
- Мониторинг здоровья и метрики производительности

**Health Check:** `GET http://localhost:3001/status`
**Зависимости:**
- **Backend API:** Конфигурация ботов и обработка сообщений
- **База данных:** Экземпляры ботов и данные диалогов
- **Telegram API:** Валидация bot токенов и настройка webhook

**Документация:** `docs/runbooks/workers.md`
**Мониторинг:** `docs/admin/bots-monitoring.md`

## 4. Подсистема AI сервисов

**Точка входа:** `ai/ai_providers.py`
**Технология:** Python async/await
**Интегрирован с:** Backend API

**Описание:** Интеллектуальная система маршрутизации AI с поддержкой мульти-провайдеров, token pooling и автоматическим failover.

**Ключевые компоненты:**
- **AI провайдеры** (`ai_providers.py`) - Интеграция мульти-провайдеров
- **Token Manager** (`ai_token_manager.py`) - Token pooling и ротация
- **Proxy Manager** (`proxy_manager.py`) - Система proxy failover
- **Система обучения** (`training_system.py`) - Улучшение AI

**Поддерживаемые провайдеры:**
- OpenAI (GPT-4o, GPT-4o-mini, GPT-4)
- YandexGPT (российская оптимизация)
- Anthropic Claude (резервный)
- GigaChat (для соответствия требованиям)

**Функции:**
- Интеллектуальная маршрутизация на основе use case
- Circuit breaker для отказавших провайдеров
- Аналитика использования токенов и оптимизация затрат
- Proxy pool с автоматическим failover

**Документация:** `docs/ai/routing.md`
**Admin API:** `/api/admin/ai-tokens`

## 5. Система биллинга и баланса

**Точка входа:** `services/balance_service.py`
**Таблицы БД:** `user_balances`, `balance_transactions`, `service_prices`
**Интегрирован с:** Backend API

**Описание:** Комплексная система биллинга с ценообразованием сервисов, отслеживанием транзакций и интеграцией платежного шлюза.

**Функции:**
- Мульти-сервисное ценообразование (AI сообщения, документы, bot сообщения)
- Отслеживание баланса в реальном времени и квоты
- История транзакций и аналитика
- Промокоды и реферальная система
- Интеграция платежей YooKassa

**Ценообразование сервисов:**
- AI сообщение: ~0.001 ₽
- Загрузка документа: ~0.10 ₽
- Bot сообщение: ~0.001 ₽
- Генерация Embedding: ~0.0001 ₽

**API Endpoints:** `/api/balance/*`
**Документация:** `docs/billing/model.md`, `docs/billing/limits_quotas.md`

## 6. Сервис базы данных

**Технология:** PostgreSQL 14+ с расширением pgvector
**Точка входа:** `database/connection.py`
**Порт:** 5432

**Описание:** Основной слой персистентности данных с возможностями векторного поиска для AI embeddings.

**Ключевые функции:**
- 30+ оптимизированных таблиц с правильными связями
- Расширение pgvector для семантического поиска
- Комплексное индексирование для производительности
- Alembic миграции для управления схемой
- Connection pooling и оптимизация запросов

**Критические таблицы:**
- `users` - Аккаунты пользователей и аутентификация
- `assistants` - Конфигурации AI ассистентов
- `dialogs` - Управление разговорами
- `dialog_messages` - Отдельные сообщения
- `knowledge_embeddings` - Данные векторного поиска
- `ai_token_pool` - Управление AI токенами

**Производительность:**
- 30+ production-ready индексов
- IVFFLAT индексы векторного подобия
- Connection pooling с SQLAlchemy
- Оптимизация и мониторинг запросов

**Миграции:** `alembic/versions/` (8 production-ready миграций)
**Схема:** `docs/db/schema.md`
**Runbook:** `docs/runbooks/database.md`

## 7. Сервис кэша и сессий

**Технология:** Redis 6+
**Точка входа:** `cache/redis_cache.py`
**Порт:** 6379

**Описание:** Высокопроизводительный сервис кэширования и управления сессиями.

**Случаи использования:**
- Хранение и управление сессиями
- Кэширование API ответов
- Счетчики rate limiting
- Pub/Sub сообщения для real-time функций
- Отслеживание использования AI токенов

**Функции:**
- Автоматическое управление TTL
- Мониторинг cache hit rate
- Pub/Sub для распределения событий
- Шифрование данных сессий

**Health Check:** `redis-cli ping`
**Мониторинг:** Встроен в endpoint `/health`

## 8. Frontend сервис

**Точка входа:** `frontend/pages/`
**Технология:** Next.js 13.5.11 / React 18.2.0
**Порт:** 3000 (HTTP)

**Описание:** Современный React-based frontend с комплексным admin dashboard и клиентским виджетом.

**Ключевые функции:**
- 39 страниц включая полную админ панель
- 19 кастомных React хуков
- Tailwind CSS с design токенами
- Mantine UI компоненты
- Интеграция real-time SSE

**Основные разделы:**
- **Пользовательский Dashboard:** Управление ассистентами, диалогами, документами
- **Админ панель:** Мониторинг системы, управление пользователями, аналитика
- **Chat виджет:** Встраиваемый виджет клиентской поддержки
- **Интерфейс оператора:** Управление handoff человеку

**Зависимости:**
- **Backend API:** Все данные и бизнес-логика
- **SSE сервис:** Обновления в реальном времени
- **Аутентификация:** Валидация JWT токенов

**Runbook:** `docs/runbooks/frontend.md`
**Архитектура:** `docs/frontend/structure-guide.md`

## 9. Сервис мониторинга и аналитики

**Точка входа:** `monitoring/` (множественные компоненты)
**Технология:** Prometheus метрики / Кастомная аналитика
**Интегрирован с:** Backend API

**Описание:** Комплексная система мониторинга, сбора метрик и бизнес-аналитики.

**Компоненты:**
- **Prometheus метрики:** Системные и бизнес метрики
- **Health мониторинг:** Отслеживание статуса компонентов
- **Audit логирование:** Отслеживание безопасности и соответствия требованиям
- **Мониторинг БД:** Отслеживание размера и анализ роста
- **Rate Limit мониторинг:** Соответствие Telegram API

**Категории метрик:**
- **Системные метрики:** CPU, память, диск, сеть
- **Метрики приложения:** Время ответа API, частота ошибок
- **Бизнес метрики:** Активность пользователей, доход, использование ботов
- **AI метрики:** Использование токенов, производительность модели

**Endpoints:**
- `/health` - Статус здоровья системы
- `/metrics` - Prometheus метрики
- `/api/admin/analytics/*` - Бизнес аналитика

## 10. Сервис безопасности

**Точка входа:** `core/security/` (множественные модули)
**Технология:** JWT, CSRF, CORS middleware
**Интегрирован с:** Backend API

**Описание:** Многослойная система безопасности с аутентификацией, авторизацией и защитой от угроз.

**Компоненты:**
- **Аутентификация:** JWT токены с настраиваемым истечением
- **CSRF защита:** Динамическая валидация токенов
- **CORS управление:** Динамические политики на основе origin
- **Security headers:** HSTS, CSP, X-Frame-Options
- **Rate limiting:** Лимиты per-endpoint и per-user
- **Интеграция Fail2ban:** Предотвращение вторжений

**Функции:**
- Role-based access control (user/admin/operator)
- Динамический CSP для iframe встраивания
- File-based управление секретами
- Логирование событий безопасности и оповещения

**Документация:** `docs/security/threat_model.md`
**Реализация:** `docs/security/authentication.md`

## 11. Сервис управления документами

**Точка входа:** `services/document_service.py`
**Хранилище:** Директория `/uploads`
**Интегрирован с:** Backend API

**Описание:** Система обработки документов и управления knowledge base.

**Функции:**
- Поддержка мульти-форматных документов (PDF, DOCX, TXT, MD)
- Генерация векторных embeddings для семантического поиска
- Чанкинг и индексирование документов
- Версионирование knowledge base
- Валидация файлов и сканирование безопасности

**Поддерживаемые форматы:**
- PDF документы
- Microsoft Word (.docx)
- Простой текст (.txt)
- Markdown (.md)

**AI интеграция:**
- Автоматическое извлечение текста
- Генерация векторных embeddings
- Семантический поиск с pgvector
- Context-aware AI ответы

**API Endpoints:** `/api/documents/*`

## 12. Сервис админ Dashboard

**Точка входа:** `/api/admin/*` (Backend) + `pages/admin/*` (Frontend)
**Технология:** FastAPI + Next.js
**Аутентификация:** Требуется роль Admin

**Описание:** Комплексный административный интерфейс для управления системой и мониторинга.

**Ключевые функции:**
- **Управление пользователями:** Администрирование аккаунтов и поддержка
- **Системная аналитика:** Метрики в реальном времени и business intelligence
- **Управление AI токенами:** Конфигурация провайдеров и мониторинг
- **Мониторинг ботов:** Статус ботов в реальном времени и производительность
- **Системные настройки:** Управление конфигурацией
- **Мониторинг безопасности:** Аудит логи и security оповещения

**Real-time функции:**
- Живые системные метрики
- Мониторинг производительности ботов
- Отслеживание активности пользователей
- Аналитика дохода

**API покрытие:** 20+ admin-специфичных endpoints
**Документация:** `docs/admin/architecture.md`

## Матрица зависимостей сервисов

| Сервис | PostgreSQL | Redis | OpenAI | Telegram | SMTP | Files |
|---------|-----------|-------|--------|----------|------|-------|
| **Backend API** | ✅ Основной | ✅ Кэш | ✅ AI | ➖ Только API | ✅ Emails | ✅ Uploads |
| **SSE сервис** | ➖ Только чтение | ✅ Pub/Sub | ➖ Нет | ➖ Нет | ➖ Нет | ➖ Нет |
| **Bot воркеры** | ✅ Диалоги | ✅ Состояние | ➖ Нет | ✅ Основной | ➖ Нет | ➖ Нет |
| **AI сервис** | ✅ Токены | ✅ Кэш | ✅ Основной | ➖ Нет | ➖ Нет | ➖ Нет |
| **Frontend** | ➖ Нет | ➖ Нет | ➖ Нет | ➖ Нет | ➖ Нет | ➖ Нет |

## Порядок запуска сервисов

**Последовательность production развертывания:**
1. **PostgreSQL** - Сервис базы данных (первый)
2. **Redis** - Кэш и сообщения
3. **Backend API** - Основной сервис приложения
4. **Bot воркеры** - Управление Telegram ботами
5. **Frontend** - Пользовательский интерфейс (последний)

**Последовательность Health Check:**
```bash
# 1. Проверить базу данных
psql $DATABASE_URL -c "SELECT 1;"

# 2. Проверить Redis
redis-cli ping

# 3. Проверить backend
curl http://localhost:8000/health

# 4. Проверить bot воркеры
curl http://localhost:3001/status

# 5. Проверить frontend
curl http://localhost:3000/
```

## Экстренные контакты и Runbooks

| Сервис | Основной Runbook | Экстренная процедура | Health Check |
|---------|----------------|-------------------|--------------|
| **Backend API** | `docs/runbooks/backend.md` | Перезапуск сервиса | `/health` |
| **Bot воркеры** | `docs/runbooks/workers.md` | Перезапуск manager | `:3001/status` |
| **База данных** | `docs/runbooks/database.md` | Проверить подключения | `psql -c "SELECT 1"` |
| **Frontend** | `docs/runbooks/frontend.md` | Пересобрать/перезапустить | Ручная проверка |
| **Redis** | `docs/runbooks/backend.md` | Перезапуск сервиса | `redis-cli ping` |

Этот каталог сервисов предоставляет комплексный обзор всех сервисов платформы ReplyX, их взаимозависимостей и операционных процедур для production окружений.