# Manual Verification Checklist –¥–ª—è WebSocket iframe —Ñ–∏–∫—Å–æ–≤

## –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –≤ production

### üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

- [ ] **WS_TRUSTED_IFRAME_HOSTS** –∑–∞–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
  ```bash
  # Production
  WS_TRUSTED_IFRAME_HOSTS="replyx.ru,www.replyx.ru"
  
  # Development (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
  WS_TRUSTED_IFRAME_HOSTS="replyx.ru,www.replyx.ru,localhost:3000"
  ```

- [ ] **WS_REQUIRE_TOKEN_SIGNATURE** –≤–∫–ª—é—á–µ–Ω –≤ production:
  ```bash
  WS_REQUIRE_TOKEN_SIGNATURE=true
  ```

- [ ] **SECRET_KEY** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –±–µ–∑–æ–ø–∞—Å–µ–Ω (–¥–ª—è JWT –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å regression —Ç–µ—Å—Ç—ã:
  ```bash
  cd backend
  python -m pytest tests/test_iframe_domain_validation.py -v
  ```
  –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: **–≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç** (‚úÖ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ iframe —Å—Ü–µ–Ω–∞—Ä–∏–∏, ‚ùå –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)

- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ WebSocket —Ç–µ—Å—Ç—ã:
  ```bash
  python -m pytest tests/test_websocket_critical_fixes.py -v
  ```

#### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ stencom.ru —Å—Ü–µ–Ω–∞—Ä–∏—è

1. **–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è stencom.ru**:
   ```bash
   # –í backend –∫–æ–Ω—Å–æ–ª–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ API
   # –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å: "allowed_domains": "stencom.ru"
   ```

2. **–í—Å—Ç—Ä–æ–∏—Ç—å widget –Ω–∞ —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É stencom.ru**:
   ```html
   <!-- –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ stencom.ru -->
   <iframe src="https://replyx.ru/widget/chat?site_token=–í–ê–®–ï_–¢–û–ö–ï–ù&assistant_id=3" 
           width="400" height="600"></iframe>
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**:
   - –û—Ç–∫—Ä—ã—Ç—å browser dev tools ‚Üí Network ‚Üí WS
   - –ù–∞–π—Ç–∏ WebSocket connection –∫ `wss://replyx.ru/ws/site/dialogs/...`
   - **‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è**: Connection successful (101 Switching Protocols)
   - **‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å**: Close code 4003

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend**:
   ```bash
   # –í production –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏:
   grep "Iframe scenario" /var/log/replyx/backend.log | tail -5
   
   # –û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç:
   # [Domain] Iframe scenario: origin=https://replyx.ru (trusted), validating parent_origin=https://stencom.ru -> stencom.ru
   ```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã)

1. **–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ–º–µ–Ω**:
   - –í—Å—Ç—Ä–æ–∏—Ç—å widget –Ω–∞ evil.com —Å —Ç–æ–∫–µ–Ω–æ–º stencom.ru
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è**: WebSocket close code 4003

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ parent_origin**:
   - –ü—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ `https://replyx.ru/widget/chat?site_token=...`
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è**: WebSocket close code 4003

3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π parent_origin**:
   - –ú–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `&parent_origin=evil.com`
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è**: WebSocket close code 4003

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

- [ ] **–õ–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è**:
  ```bash
  # –ü–æ–∏—Å–∫ –≤ –ª–æ–≥–∞—Ö 4003 –æ—à–∏–±–æ–∫:
  grep "WEBSOCKET_4003_ERROR" /var/log/replyx/backend.log
  
  # –£—Å–ø–µ—à–Ω—ã–µ iframe –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
  grep "Iframe scenario.*validating parent_origin" /var/log/replyx/backend.log
  ```

- [ ] **–ê–ª–µ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥):
  - –°–ª—ç–∫/email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ 4003 –æ—à–∏–±–æ–∫
  - Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç WebSocket connection success rate

### üöÄ Production Deployment Steps

1. **–û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
   ```bash
   # –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ
   export WS_TRUSTED_IFRAME_HOSTS="replyx.ru,www.replyx.ru"
   export WS_REQUIRE_TOKEN_SIGNATURE=true
   ```

2. **–î–µ–ø–ª–æ–π –∫–æ–¥–∞**:
   - Backend: –æ–±–Ω–æ–≤–∏—Ç—å `websocket_manager.py`, `app_config.py`
   - Frontend: –æ–±–Ω–æ–≤–∏—Ç—å `chat-iframe.js` —Å parent_origin –ª–æ–≥–∏–∫–æ–π

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è**:
   - [ ] Health check WebSocket endpoints –¥–æ—Å—Ç—É–ø–Ω—ã
   - [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
   - [ ] stencom.ru widget –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –±–µ–∑ 4003

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞**:
   - [ ] –°–ª–µ–¥–∏—Ç—å –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º 4003 –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ –Ω–æ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏
   - [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã

### üÜò Rollback –ø–ª–∞–Ω

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫:

1. **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**:
   ```bash
   # –í—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –¥–æ–º–µ–Ω—ã (–¢–û–õ–¨–ö–û –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Å–ª—É—á–∞—è)
   export WS_REQUIRE_TOKEN_SIGNATURE=false
   ```

2. **–û—Ç–∫–∞—Ç –∫–æ–¥–∞**:
   - –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é `websocket_manager.py`
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**:
   - [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
   - [ ] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–º–µ–Ω—ã –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è

### ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

–≠—Ç–æ—Ç —á–µ–∫–ª–∏—Å—Ç –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–º –∫–æ–≥–¥–∞:
- ‚úÖ –í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ stencom.ru iframe —Å—Ü–µ–Ω–∞—Ä–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ 4003
- ‚úÖ –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç unauthorized –¥–æ–º–µ–Ω—ã
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
- ‚úÖ Rollback –ø–ª–∞–Ω –≥–æ—Ç–æ–≤

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å–ø–µ—Ö–∞**: –≤–∏–¥–∂–µ—Ç –Ω–∞ stencom.ru –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket **–±–µ–∑ –∫–æ–¥–∞ 4003**.