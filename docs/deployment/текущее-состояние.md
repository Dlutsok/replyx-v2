# Текущее состояние развертывания

**Последнее обновление:** 2025-09-02 (обновлено после реорганизации)

Этот документ описывает текущую конфигурацию развертывания и операционное состояние приложения ChatAI MVP 13 после реорганизации репозитория.

## Обзор развертывания

### Структура приложения
```
/opt/chatai/           # Production deployment (or development path)
├── backend/           # FastAPI Python backend
├── frontend/          # Next.js React frontend  
├── docs/             # Documentation (this)
└── uploads/          # File storage directory
```

**Путь разработки:** `/Users/dan/Documents/chatAI/MVP 9/`  
**Путь продакшена:** `/opt/chatai/`

### Процессы времени выполнения

#### Процессы Backend
1. **FastAPI Backend** (`backend/main.py`)
   - **Порт:** 8000 (по умолчанию)
   - **Окружение:** Разработка/Продакшен на основе переменной `ENVIRONMENT`
   - **Управление процессом:** Прямое выполнение Python или systemd сервис
   - **Логирование:** Ротация логов в `backend/logs/api.log`

2. **Масштабируемый менеджер ботов** (`backend/master/scalable_bot_manager.js`)
   - **Порт:** 3001 (webhook сервер)
   - **PID файл:** `scripts/backend/pids/master.pid` (перемещен в корень)
   - **Управление рабочими:** Запускает изолированных Node.js bot workers
   - **Пропускная способность:** До 1000 одновременных Telegram ботов
   - **Мониторинг процессов:** Автоперезапуск при сбое

3. **Рабочие ботов** (`backend/worker/bot_worker.js`)
   - **Тип процесса:** Дочерние процессы, запускаемые главным процессом
   - **Изоляция:** Каждый бот работает в отдельном Node.js процессе
   - **Коммуникация:** IPC с главным процессом
   - **Лимит памяти:** ~150МБ на рабочий процесс

#### Процесс Frontend
1. **Next.js Frontend** (`frontend/`)
   - **Порт:** 3000 (разработка) / 80,443 (продакшен)
   - **Процесс сборки:** `npm run build` + `npm start`
   - **Статические ресурсы:** Собираются в `frontend/.next/`
   - **Окружение:** React 18 с поддержкой TypeScript

### Конфигурация базы данных

#### База данных PostgreSQL
- **Требуемое расширение:** pgvector для эмбеддингов
- **Пул соединений:** SQLAlchemy с настраиваемым размером пула
- **Управление миграциями:** Alembic (50+ файлов миграций)
- **Стратегия резервного копирования:** Автоматическая через `scripts/backend/database_backup.py` (перемещен в корень)
- **Мониторинг производительности:** Отслеживание размера базы данных включено

#### Конфигурация Redis
- **Назначение:** Кеширование сессий, состояние WebSocket, ограничение скорости
- **Проверка доступности:** Встроена в эндпоинт проверки состояния
- **Отказоустойчивость:** Приложение продолжает работать с ухудшенной производительностью, если Redis недоступен

### Хранение файлов

#### Структура каталога загрузок
```
uploads/
├── {user_id}/               # User-specific uploads
│   ├── documents/          # Knowledge base documents
│   └── avatars/            # User avatars
└── system/                 # System files
    └── backups/            # Database backups
```

#### File Processing
- **Supported Types:** PDF, DOCX, TXT, MD
- **Validation:** File type, size limits, malware scanning
- **Processing:** Automatic text extraction and embedding generation
- **Cleanup:** Automated cleanup via `scripts/backend/cleanup_uploads.py` (moved to root)

## Конфигурация окружения

### Переменные окружения

#### Основные настройки приложения
```bash
# Application Environment
ENVIRONMENT=production                    # production/development/local
FRONTEND_URL=http://localhost:3000       # Frontend URL for redirects
CORS_ORIGINS=https://domain.com          # Comma-separated allowed origins

# Database Configuration  
DATABASE_URL=postgresql://user:pass@host:5432/chatai
REDIS_URL=redis://localhost:6379/0

# Security Settings
SECRET_KEY=your-secret-key-here          # JWT signing key
ENABLE_CSRF_PROTECTION=true              # Enable CSRF protection
ALGORITHM=HS256                          # JWT algorithm
ACCESS_TOKEN_EXPIRE_MINUTES=1440         # Token expiration (24 hours)

# AI Configuration
OPENAI_API_KEY=sk-...                    # Primary OpenAI API key
AI_TOKEN_POOL_ENABLED=true               # Enable token pooling

# Email Configuration
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=notifications@domain.com
SMTP_PASSWORD=app-password
```

#### Мониторинг и наблюдаемость
```bash
# Prometheus Metrics
PROMETHEUS_ENABLED=true
METRICS_PORT=8001

# Logging Configuration
LOG_LEVEL=INFO
LOG_ROTATION=daily
LOG_RETENTION_DAYS=7

# Health Check Configuration
HEALTH_CHECK_INTERVAL=30
```

### Конфигурационные файлы

#### Backend Configuration (`backend/core/app_config.py`)
- JWT settings and security parameters
- Database connection settings
- CORS configuration
- Rate limiting settings

#### Frontend Configuration (`frontend/next.config.js`)
- Build optimization settings
- API proxy configuration
- Static asset handling

#### Alembic Configuration (`backend/alembic.ini`)
- Database migration settings
- Connection string template
- Migration script location

### Конфигурация безопасности

#### Fail2ban Integration
- **Configuration:** `backend/security/jail.local`
- **Monitoring:** Failed login attempts, brute force protection
- **Auto-ban:** Configurable thresholds and durations
- **Log Analysis:** Automated via `backend/security/fail2ban_monitor.py`

#### CSRF Protection
- **Status:** Configurable via `ENABLE_CSRF_PROTECTION`
- **Implementation:** Custom middleware in `backend/core/csrf_protection.py`
- **Token Endpoint:** `/api/csrf-token` for frontend integration

#### Security Headers
- **Implementation:** `backend/core/security_headers.py`
- **Headers Applied:**
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: DENY`
  - `X-XSS-Protection: 1; mode=block`
  - `Strict-Transport-Security` (HTTPS only)

## Операционный мониторинг

### Эндпоинты проверки состояния

#### Application Health (`/health`)
```json
{
  "status": "healthy",
  "timestamp": 1640995200.123,
  "components": {
    "database": {"status": "healthy"},
    "redis": {"status": "healthy"}, 
    "ai_token_manager": {"status": "healthy"}
  }
}
```

#### Prometheus Metrics (`/metrics`)
- **HTTP Request Metrics:** Latency, count by endpoint
- **Database Metrics:** Connection pool status, query performance  
- **Redis Metrics:** Connection status, cache hit rates
- **WebSocket Metrics:** Active connections count
- **Custom Metrics:** Bot instance counts, AI token usage

#### Database Monitoring (`/metrics/db-size`)
- **Database Size:** Total size in bytes
- **Table Sizes:** Individual table sizes
- **Growth Rate:** MB per day growth rate
- **Disk Usage:** Available disk space percentage
- **Health Status:** healthy/warning/critical based on thresholds

#### Bot Monitoring (`/metrics/telegram-rate-limit`)
- **Active Bots:** Current running bot instances
- **Message Throughput:** Messages per second per bot
- **Rate Limits:** Telegram API compliance status
- **Queue Status:** Message queue sizes and processing delays
- **Worker Health:** Process status and memory usage

### Управление логами

#### Log Files Location
```
backend/logs/
├── api.log                    # Main application logs
├── api.log.YYYY-MM-DD        # Rotated daily logs
├── audit.log                 # Security audit logs  
└── audit.log.YYYY-MM-DD      # Rotated audit logs
```

#### Log Rotation
- **Frequency:** Daily at midnight
- **Retention:** 7 days of rotated logs
- **Format:** Structured logging with timestamps, levels, and context
- **Monitoring:** Log analysis via monitoring scripts

### Управление процессами

#### System Services (Systemd)
```ini
# /etc/systemd/system/chatai-backend.service
[Unit]
Description=ChatAI Backend Service
After=postgresql.service redis.service

[Service]
Type=simple
User=chatai
WorkingDirectory=/opt/chatai/backend
ExecStart=/opt/chatai/venv/bin/python3 main.py
Restart=always
RestartSec=10
Environment=ENVIRONMENT=production

[Install]
WantedBy=multi-user.target
```

```ini
# /etc/systemd/system/chatai-bot-manager.service
[Unit]
Description=ChatAI Bot Manager
After=chatai-backend.service

[Service]
Type=simple
User=chatai
WorkingDirectory=/opt/chatai/backend
ExecStart=/usr/bin/node master/scalable_bot_manager.js
Restart=always
RestartSec=15

[Install]
WantedBy=multi-user.target
```

#### Process Monitoring Scripts
- **System Monitor:** `scripts/backend/system_monitor.py` (moved to root)
- **FastAPI Monitor:** `scripts/backend/fastapi_monitor.py` (moved to root)
- **Database Size Cron:** `backend/monitoring/db_size_cron.sh`

### Оптимизация производительности

#### Database Optimizations
- **Indexes:** 15+ performance indexes on critical queries
- **Connection Pooling:** SQLAlchemy pool with configurable size
- **Query Optimization:** N+1 query prevention, eager loading
- **pg_stat_statements:** Query performance monitoring enabled

#### Caching Strategy
- **Redis Caching:** Frequent queries, session data, rate limits
- **Application Cache:** In-memory caching for static data
- **CDN Integration:** Static assets served via CDN (production)

#### Bot Worker Optimization
- **Process Isolation:** Each bot in separate process prevents cascading failures
- **Memory Management:** Automatic garbage collection and memory monitoring
- **Rate Limiting:** Telegram API compliance with intelligent backoff
- **Message Deduplication:** Prevents duplicate message processing

## Резервное копирование и восстановление

### Database Backup Strategy
- **Automated Backups:** Daily via `scripts/backend/database_backup.py` (moved to root)
- **Backup Location:** `backend/data/backups/`
- **Retention:** 30 days of daily backups
- **Backup Verification:** Automated restore testing

### File Storage Backup
- **User Uploads:** Included in regular backup cycle
- **System Files:** Configuration and scripts backed up separately
- **Disaster Recovery:** Documented restoration procedures

### Configuration Backup
- **Environment Files:** Version controlled (without secrets)
- **Database Schema:** Alembic migrations in version control
- **Security Configs:** Fail2ban, SSL certificates backed up

## Процедуры развертывания

### Развертывание Backend
```bash
# 1. Update code
git pull origin main

# 2. Install dependencies
pip install -r requirements.txt

# 3. Run database migrations
alembic upgrade head

# 4. Restart services
sudo systemctl restart chatai-backend
sudo systemctl restart chatai-bot-manager

# 5. Verify health
curl http://localhost:8000/health
```

### Развертывание Frontend
```bash
# 1. Update code
git pull origin main

# 2. Install dependencies
cd frontend && npm install

# 3. Build production assets
npm run build

# 4. Restart frontend service
sudo systemctl restart chatai-frontend

# 5. Clear CDN cache (if applicable)
# CDN cache invalidation commands
```

### Zero-Downtime Deployment
- **Database Migrations:** Backward-compatible migrations first
- **Feature Flags:** Gradual rollout of new features
- **Health Checks:** Automated verification before traffic routing
- **Rollback Procedures:** Quick rollback via git tags and service restart

## Устранение неполадок

### Общие проблемы

#### Database Connection Issues
```bash
# Check PostgreSQL status
sudo systemctl status postgresql

# Check connection from application
psql $DATABASE_URL -c "SELECT 1;"

# Review database logs
sudo tail -f /var/log/postgresql/postgresql-*.log
```

#### Bot Worker Issues
```bash
# Check master process
ps aux | grep scalable_bot_manager

# Check worker processes
ps aux | grep bot_worker

# Review bot logs
tail -f backend/logs/api.log | grep -i "bot"

# Restart bot system
sudo systemctl restart chatai-bot-manager
```

#### Memory Issues
```bash
# Check system memory
free -h

# Check process memory usage
ps aux --sort=-%mem | head -20

# Check bot worker memory
ps aux | grep bot_worker | awk '{print $6}' | sort -n
```

### Log Analysis Commands
```bash
# API errors in last hour
grep ERROR backend/logs/api.log | tail -100

# Failed authentication attempts  
grep "401\|403" backend/logs/api.log

# Database query performance
grep -i "slow query" backend/logs/api.log

# Bot worker errors
grep -i "worker.*error" backend/logs/api.log
```

### Performance Monitoring
```bash
# Database connection pool status
curl -s http://localhost:8000/metrics | grep db_pool

# Active WebSocket connections
curl -s http://localhost:8000/metrics | grep websocket_connections

# Bot instance count
curl -s http://localhost:8000/metrics/telegram-rate-limit | grep total_bots
```

## Аспекты безопасности

### Текущие меры безопасности
- **Authentication:** JWT tokens with configurable expiration
- **CSRF Protection:** Enabled in production environment
- **Rate Limiting:** Per-endpoint and global rate limits
- **Input Validation:** Comprehensive input sanitization
- **SQL Injection Prevention:** SQLAlchemy ORM with parameterized queries
- **File Upload Security:** Type validation, size limits, malware scanning
- **Fail2ban Integration:** Automated intrusion detection and blocking

### Security Monitoring
- **Audit Logging:** All security-relevant actions logged
- **Failed Login Tracking:** Automated monitoring and alerting
- **Unusual Activity Detection:** Pattern recognition for suspicious behavior
- **Regular Security Scans:** Dependency vulnerability scanning

### Access Control
- **Role-Based Access:** User/admin/operator role hierarchy
- **API Key Management:** Secure storage and rotation of external API keys
- **Database Access:** Restricted database user permissions
- **System Access:** Limited user accounts with sudo restrictions

Настоящая документация о развертывании отражает текущее состояние на 2025-08-22 и должна обновляться по мере развития системы.