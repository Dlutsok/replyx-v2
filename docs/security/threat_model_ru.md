# Модель угроз и базовые требования безопасности ReplyX

**Последнее обновление:** 14 сентября 2025 г.
**Классификация:** Внутреннее использование
**Версия:** v1.3 - Полная документация безопасности

## Исполнительное резюме

ReplyX использует комплексную многослойную архитектуру безопасности, разработанную для защиты от распространенных уязвимостей веб-приложений, утечек данных и неавторизованного доступа. Данный документ описывает модель угроз, средства безопасности и стратегии митигации, реализованные в платформе.

## Обзор системы

ReplyX является multi-tenant SaaS платформой, предоставляющей AI-powered услуги клиентской поддержки. Система обрабатывает конфиденциальные данные, включая:
- Учетные данные для аутентификации пользователей
- Данные разговоров клиентов
- Конфигурации AI модели и промпты
- Платежную и биллинговую информацию
- Критически важные операционные данные

## Архитектура безопасности

### 1. Аутентификация и авторизация

#### Фреймворк многофакторной аутентификации
- **Основной:** JWT (JSON Web Tokens) с настраиваемым истечением
- **Вторичный:** CSRF токены для операций изменения состояния
- **Управление сессиями:** Redis-backed хранилище сессий с TTL
- **Role-Based Access Control (RBAC):** Трехуровневая система разрешений

**Роли и разрешения:**
```
┌─────────────┬─────────────────────────────────────────┐
│ Роль        │ Разрешения                              │
├─────────────┼─────────────────────────────────────────┤
│ user        │ Собственные ассистенты, диалоги, документы│
│ operator    │ Управление handoff, назначенные диалоги │
│ admin       │ Полный доступ к системе, управление пользователями│
└─────────────┴─────────────────────────────────────────┘
```

#### Детали реализации
```python
# Конфигурация JWT
ACCESS_TOKEN_EXPIRE_MINUTES = 24 * 60  # 24 часа
ALGORITHM = "HS256"
SECRET_KEY = file_based_secret("jwt_secret")

# CSRF защита
X-CSRF-Token: требуется для POST/PUT/DELETE операций
Cookie-based CSRF валидация с same-origin политикой
```

### 2. Сетевая безопасность

#### CORS (Cross-Origin Resource Sharing)
- **Динамическая CORS политика:** Конфигурация на основе origin
- **Основное приложение:** Строгая same-origin политика
- **Интеграция виджетов:** Настраиваемые разрешенные origins
- **Режим разработки:** Разрешающий доступ localhost

```python
# Динамическая CORS конфигурация
CORS_MAIN_ORIGINS = ["https://app.replyx.ru"]
CORS_WIDGET_ORIGINS = ["*"]  # Сайты клиентов
CORS_DEV_ORIGINS = ["http://localhost:3000"]
```

#### CSP (Content Security Policy)
- **Динамические CSP headers:** Генерация политики с учетом контекста
- **Iframe встраивание:** Безопасная поддержка встраивания виджетов
- **Script источники:** Строгий allowlist для доверенных доменов
- **Media источники:** Контролируемые политики загрузки медиа

```http
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://trusted-cdn.com;
  img-src 'self' data: blob:;
  connect-src 'self' wss: https:;
  frame-ancestors https://customer-domain.com;
```

### 3. Защита данных

#### Персонально идентифицируемая информация (PII)
- **Минимизация данных:** Сбор только необходимых пользовательских данных
- **Редактирование PII:** Автоматическое маскирование конфиденциальных данных в логах
- **Шифрование в покое:** Шифрование конфиденциальных данных на уровне полей БД
- **Шифрование в пути:** TLS 1.3 для всех внешних коммуникаций

#### Безопасность загрузки файлов
```python
# Валидация загрузки файлов
ALLOWED_FILE_TYPES = [".pdf", ".docx", ".txt", ".md"]
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB
UPLOAD_DIRECTORY = "/uploads"  # Изолированно от путей выполнения

# Сканирование безопасности
- Валидация MIME типов
- Проверка сигнатур файлов
- Антивирусное сканирование (production)
- Анализ содержимого на вредоносные payload'ы
```

#### Хранение данных и конфиденциальность
- **Соответствие GDPR:** Право на удаление и портируемость данных
- **Анонимизация данных:** Анонимизация пользовательских данных при удалении аккаунта
- **Audit логирование:** Комплексное отслеживание событий безопасности
- **Шифрование резервных копий:** Все резервные копии БД зашифрованы в покое

### 4. Безопасность приложения

#### Валидация и санитизация входных данных
```python
# Pydantic модели для валидации входных данных
class UserCreateRequest(BaseModel):
    email: EmailStr
    password: SecretStr = Field(min_length=8, max_length=128)
    first_name: str = Field(max_length=100)

# Предотвращение SQL инъекций
- SQLAlchemy ORM с параметризованными запросами
- Отсутствие динамического построения SQL
- Пользователь БД с минимальными привилегиями
```

#### Кодирование вывода и предотвращение XSS
- **HTML кодирование:** Все пользовательское содержимое правильно экранировано
- **JSON Response кодирование:** UTF-8 с правильными headers
- **Content-Type Headers:** Явное указание типа содержимого
- **X-Content-Type-Options:** nosniff header

#### Rate Limiting
```python
# API Rate Limiting (per endpoint)
RATE_LIMITS = {
    "auth": "100/hour",           # Endpoints аутентификации
    "registration": "50/hour",     # Регистрация аккаунта
    "password_reset": "5/hour",    # Запросы сброса пароля
    "file_upload": "20/hour",      # Загрузки документов
    "ai_messages": "1000/hour",    # AI взаимодействия
    "general": "3600/hour"         # Общий доступ к API
}
```

### 5. Безопасность инфраструктуры

#### Управление секретами
```bash
# Production управление секретами
/secrets/
├── jwt_secret              # Ключ подписи JWT
├── database_password       # Учетные данные БД
├── openai_api_keys        # Токены AI провайдеров
├── email_password         # SMTP учетные данные
└── payment_webhook_secret # Верификация платежного шлюза

# Разработка (.env файл)
SECRET_KEY=dev-secret-key-change-in-production
DATABASE_URL=postgresql://user:pass@localhost/db
OPENAI_API_KEY=sk-development-key
```

#### Безопасность базы данных
- **Безопасность подключений:** TLS-зашифрованные подключения к БД
- **Привилегии пользователей:** Отдельные пользователи БД для различных сервисов
- **Мониторинг запросов:** Логирование и анализ медленных запросов
- **Безопасность резервных копий:** Зашифрованные резервные копии с отдельными учетными данными для хранения

#### Безопасность Redis
- **Аутентификация:** Парольная защита Redis
- **Сетевая изоляция:** Правила файервола, ограничивающие доступ к Redis
- **Шифрование данных:** Конфиденциальные данные сессий зашифрованы перед хранением
- **Безопасность памяти:** Автоматическая очистка памяти для конфиденциальных операций

### 6. Мониторинг и реагирование на инциденты

#### Мониторинг безопасности
```python
# Конфигурация Fail2ban
[chatai-backend]
enabled = true
filter = chatai-backend
logpath = /var/log/chatai/backend.log
maxretry = 5
findtime = 600
bantime = 3600
action = iptables-multiport[name=chatai, port="http,https"]
```

#### Audit логирование
- **События аутентификации:** Вход/выход, неудачные попытки
- **События авторизации:** Эскалация разрешений, изменения ролей
- **События доступа к данным:** Доступ к конфиденциальным данным, модификации
- **Системные события:** Изменения конфигурации, инциденты безопасности

#### Обнаружение вторжений
- **Интеграция Fail2ban:** Автоматическая блокировка IP за подозрительное поведение
- **Анализ логов:** Мониторинг логов в реальном времени для паттернов атак
- **Обнаружение аномалий:** Идентификация необычных паттернов доступа
- **Система оповещений:** Немедленное уведомление о критических событиях безопасности

## Анализ угроз

### Высокорисковые угрозы

#### 1. Обход аутентификации (OWASP A07:2021)
**Уровень риска:** ВЫСОКИЙ
**Векторы атак:**
- Манипуляция или подделка JWT токенов
- Угон сессии через XSS
- Brute force атаки на login endpoints
- CSRF атаки на аутентифицированные действия

**Меры митигации:**
- Строгое управление JWT секретами с регулярной ротацией
- CSRF токены для всех операций изменения состояния
- Rate limiting на endpoints аутентификации
- Безопасная конфигурация cookie (HttpOnly, Secure, SameSite)

#### 2. SQL инъекция (OWASP A03:2021)
**Уровень риска:** ВЫСОКИЙ
**Векторы атак:**
- Прямая SQL инъекция через поля ввода
- Second-order SQL инъекция через сохраненные данные
- Time-based blind SQL инъекции

**Меры митигации:**
- Исключительное использование SQLAlchemy ORM с параметризованными запросами
- Валидация входных данных с использованием Pydantic моделей
- Пользователь БД с минимальными привилегиями
- Регулярное тестирование безопасности и code review

#### 3. Утечка конфиденциальных данных (OWASP A02:2021)
**Уровень риска:** ВЫСОКИЙ
**Векторы атак:**
- Незашифрованная передача данных
- Слабая реализация шифрования
- Утечка данных через логи или сообщения об ошибках
- Неавторизованный доступ к БД

**Меры митигации:**
- TLS 1.3 для всех внешних коммуникаций
- Шифрование конфиденциальных данных на уровне полей
- Редактирование PII в логах и сообщениях об ошибках
- Контроль доступа к БД и мониторинг

#### 4. Cross-Site Scripting (XSS) (OWASP A03:2021)
**Уровень риска:** СРЕДНИЙ
**Векторы атак:**
- Stored XSS через пользовательский контент
- Reflected XSS через URL параметры
- DOM-based XSS в frontend компонентах

**Меры митигации:**
- Content Security Policy (CSP) headers
- Кодирование вывода для всего пользовательского контента
- Валидация и санитизация входных данных
- Защита современных фреймворков (React, FastAPI)

### Среднерисковые угрозы

#### 5. Нарушенный контроль доступа (OWASP A01:2021)
**Уровень риска:** СРЕДНИЙ
**Векторы атак:**
- Горизонтальная эскалация привилегий (доступ к данным других пользователей)
- Вертикальная эскалация привилегий (получение admin доступа)
- Атаки прямой ссылки на объект

**Меры митигации:**
- Комплексная реализация RBAC
- Проверки авторизации на уровне объектов
- Регулярный аудит контроля доступа
- Принцип минимальных привилегий

#### 6. Неправильная конфигурация безопасности (OWASP A05:2021)
**Уровень риска:** СРЕДНИЙ
**Векторы атак:**
- Использование учетных данных по умолчанию
- Включенные ненужные сервисы
- Подробные сообщения об ошибках
- Отсутствующие security headers

**Меры митигации:**
- Infrastructure as Code (IaC) с базовыми требованиями безопасности
- Регулярные аудиты конфигурации безопасности
- Автоматизированная реализация security headers
- Production-специфичная обработка ошибок

### Низкорисковые угрозы

#### 7. Недостаточное логирование и мониторинг (OWASP A09:2021)
**Уровень риска:** НИЗКИЙ
**Текущий статус:** Хорошо смягчено через комплексное audit логирование

#### 8. Server-Side Request Forgery (SSRF) (OWASP A10:2021)
**Уровень риска:** НИЗКИЙ
**Текущий статус:** Ограниченные внешние API вызовы со строгой валидацией

## План реагирования на инциденты

### 1. Обнаружение и оценка (0-15 минут)
- Автоматические оповещения запускают уведомление команды безопасности
- Первоначальная оценка серьезности угрозы и области воздействия
- Изоляция затронутых систем при необходимости

### 2. Сдерживание и митигация (15-60 минут)
- Реализация временных мер митигации
- Блокировка вредоносных IP адресов или аккаунтов пользователей
- Развертывание экстренных патчей при наличии

### 3. Расследование и форензика (1-24 часа)
- Детальный анализ логов и криминалистическое расследование
- Определение первопричины и методологии атаки
- Документирование доказательств для потенциальных судебных разбирательств

### 4. Восстановление и реставрация (24-72 часа)
- Реализация постоянных исправлений для выявленных уязвимостей
- Восстановление затронутых сервисов и проверка целостности системы
- Проведение дополнительного тестирования безопасности

### 5. Пост-инцидентный анализ (72+ часов)
- Комплексный анализ инцидента и извлеченные уроки
- Обновление процедур и средств безопасности
- Информирование заинтересованных сторон о результатах

## Тестирование и валидация безопасности

### Регулярные активности безопасности
- **Ежеквартально:** Тестирование проникновения внешней фирмой безопасности
- **Ежемесячно:** Автоматизированное сканирование уязвимостей
- **Еженедельно:** Оценка уязвимостей зависимостей
- **Ежедневно:** Анализ и проверка логов безопасности

### Соответствие требованиям и стандарты
- **OWASP Top 10:** Регулярная оценка против текущих угроз
- **Соответствие GDPR:** Реализация принципов privacy by design
- **SOC 2 Type II:** Подготовка к ежегодному аудиту безопасности
- **ISO 27001:** Соответствие управлению информационной безопасностью

## Метрики и KPI безопасности

### Ключевые индикаторы безопасности
```python
# Dashboard метрик безопасности
SECURITY_METRICS = {
    "failed_login_attempts": "< 100/день",
    "successful_attacks": "0",
    "security_incidents": "< 1/месяц",
    "vulnerability_remediation": "< 48 часов",
    "uptime_availability": "> 99.9%",
    "backup_success_rate": "> 99%"
}
```

### Endpoints мониторинга
- **Здоровье безопасности:** `GET /api/security/health`
- **Threat Intelligence:** `GET /api/admin/security/threats`
- **Audit логи:** `GET /api/admin/security/audit`

Эта комплексная модель угроз обеспечивает надежную основу безопасности для платформы ReplyX, адресуя текущие угрозы и оставаясь адаптируемой к новым вызовам безопасности.