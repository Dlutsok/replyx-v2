# –ó–∞—â–∏—Ç–∞ –æ—Ç —Ç—Ä–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç —Ç—Ä–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–Ω—É–ª–µ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö LLM –≤—ã–∑–æ–≤–æ–≤** –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç—Ä–∞—Ç –Ω–∞ API-–≤—ã–∑–æ–≤—ã –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, CI/CD –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞—â–∏—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   conftest.py       ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Session Fixture ‚îÇ ‚îÇ ‚Üê –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îÇ ‚îÇ Function Fixture‚îÇ ‚îÇ ‚Üê –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ws_config.py      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ ENVIRONMENT     ‚îÇ ‚îÇ ‚Üê test/ci/development/production
‚îÇ ‚îÇ IS_TEST_ENV     ‚îÇ ‚îÇ ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
‚îÇ ‚îÇ BLOCK_EXTERNAL_IO‚îÇ ‚îÇ ‚Üê –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä—É–±–∏–ª—å–Ω–∏–∫ 
‚îÇ ‚îÇ LLM_PROVIDER    ‚îÇ ‚îÇ ‚Üê fake/openai/anthropic
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   llm_client.py     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ get_llm()       ‚îÇ ‚îÇ ‚Üê –§–∞–±—Ä–∏–∫–∞ LLM –∫–ª–∏–µ–Ω—Ç–æ–≤
‚îÇ ‚îÇ   ‚îú‚îÄFakeLLM     ‚îÇ ‚îÇ ‚Üê 0 —Ç–æ–∫–µ–Ω–æ–≤, 0 —Å—Ç–æ–∏–º–æ—Å—Ç—å
‚îÇ ‚îÇ   ‚îú‚îÄOpenAILLM   ‚îÇ ‚îÇ ‚Üê –†–µ–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö)
‚îÇ ‚îÇ   ‚îî‚îÄAnthropicLLM‚îÇ ‚îÇ ‚Üê –†–µ–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö)
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (ws_config.py)

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `ENVIRONMENT` - –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`test`, `ci`, `development`, `production`)
- `IS_TEST_ENV` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ `True` –¥–ª—è `test|ci` 
- `BLOCK_EXTERNAL_IO` - –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
- `LLM_PROVIDER` - –ø—Ä–æ–≤–∞–π–¥–µ—Ä LLM (`fake`, `openai`, `anthropic`)
- `FAKE_LLM_MODE` - —Ä–µ–∂–∏–º —Ñ–µ–π–∫–∞ (`echo`, `stub`, `script`)

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞:**
```python
IS_TEST_ENV = ENVIRONMENT.lower() in {"test", "ci"}
BLOCK_EXTERNAL_IO = os.getenv('BLOCK_EXTERNAL_IO', 'false').lower() == 'true' or IS_TEST_ENV
```

### 2. LLM –ö–ª–∏–µ–Ω—Ç—ã (llm_client.py)

#### FakeLLM - –§–µ–π–∫–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä

**–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:**
- `echo` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[FAKE/echo]`
- `stub` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
- `script` - –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä—É–µ–º—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ dialog_id

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
```python
{
    "provider": "fake",
    "mode": "echo", 
    "tokens_used": 0,      # ‚Üê –í–°–ï–ì–î–ê 0
    "cost": 0.0,           # ‚Üê –í–°–ï–ì–î–ê 0.0
    "is_fake": True        # ‚Üê –ú–∞—Ä–∫–µ—Ä —Ñ–µ–π–∫–æ–≤–æ–≥–æ –≤—ã–∑–æ–≤–∞
}
```

#### –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (OpenAILLM, AnthropicLLM)

**–ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `BLOCK_EXTERNAL_IO` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ `RuntimeError` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö
- –î—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –º–µ—Ç–æ–¥–µ `chat()`

### 3. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ (conftest.py)

#### Session-level –∑–∞—â–∏—Ç–∞
```python
@pytest.fixture(autouse=True, scope="session")
def force_test_environment():
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ"""
    test_env_vars = {
        "ENVIRONMENT": "test",
        "LLM_PROVIDER": "fake", 
        "FAKE_LLM_MODE": "echo",
        "BLOCK_EXTERNAL_IO": "true",
        "IS_TEST_ENV": "true"
    }
```

#### Function-level –≤–∞–ª–∏–¥–∞—Ü–∏—è
```python
@pytest.fixture(autouse=True, scope="function")  
def verify_no_real_llm():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ FakeLLM"""
    # –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    # –ü–µ—Ä–µ–∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π
    # –í–∞–ª–∏–¥–∞—Ü–∏—è get_llm() ‚Üí FakeLLM
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (fake –≤ —Ç–µ—Å—Ç–∞—Ö)
from services.llm_client import generate_ai_response

async def my_function():
    response = await generate_ai_response(
        messages=[{"role": "user", "content": "Hello"}],
        dialog_id=123
    )
    # –í —Ç–µ—Å—Ç–∞—Ö: response["metadata"]["is_fake"] == True
    # –í —Ç–µ—Å—Ç–∞—Ö: response["metadata"]["tokens_used"] == 0
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π dry-run
```python
from services.llm_client import get_llm

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π fake —Ä–µ–∂–∏–º –¥–∞–∂–µ –≤ production
llm = get_llm(dry_run=True)
response = await llm.chat(messages)
```

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ dry-run –∏–∑ HTTP –∑–∞–ø—Ä–æ—Å–∞
```python
from services.llm_client import check_dry_run_request

# –ò–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: X-Dry-Run: 1
# –ò–∑ query: ?dry_run=true
is_dry_run = check_dry_run_request(headers=request.headers, query_params=request.query_params)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∑–∞—â–∏—Ç—ã
```bash
# –£–ø—Ä–æ—â—ë–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
pytest tests/test_token_protection_simple.py -v

# –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
pytest tests/test_token_protection.py -v

# –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞—â–∏—Ç—ã
pytest tests/test_token_protection*.py -v
```

### –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã

1. **Environment Configuration** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. **Provider Selection** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ FakeLLM –≤ —Ç–µ—Å—Ç–∞—Ö
3. **Real Provider Blocking** - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ OpenAI/Anthropic –≤ —Ç–µ—Å—Ç–∞—Ö
4. **Concurrent Protection** - —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç 100+ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
5. **Dry-Run Detection** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ dry-run —Ä–µ–∂–∏–º–∞
6. **Production Simulation** - —Å–∏–º—É–ª—è—Ü–∏—è production —Å –∑–∞—â–∏—Ç–æ–π

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```
‚úÖ 18/18 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ
‚úÖ 0 —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ
‚úÖ 300+ concurrent –≤—ã–∑–æ–≤–æ–≤ —Å –Ω—É–ª–µ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é
```

## –û—Ç–ª–∞–¥–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```python
from services.ws_config import get_config

config = get_config()
print("LLM Config:", config['llm'])
# –í—ã–≤–æ–¥:
# {
#   'environment': 'test',
#   'is_test_env': True, 
#   'provider': 'fake',
#   'fake_mode': 'echo',
#   'block_external_io': True
# }
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞—â–∏—Ç—ã
```python
from conftest import ensure_no_tokens_spent

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –∑–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞
ensure_no_tokens_spent()  # –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –≤ –ª–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:
- `üîí LLM provider: FAKE/echo (tokens will NOT be spent)` - —Ñ–µ–π–∫–æ–≤—ã–π —Ä–µ–∂–∏–º
- `üí∞ LLM provider: OpenAI (REAL tokens will be spent)` - —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- `üö´ External IO blocked` - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤

## –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
```python
class CustomLLM(BaseLLM):
    def __init__(self, api_key: str):
        # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞!
        if BLOCK_EXTERNAL_IO:
            raise RuntimeError(
                f"üö´ External IO blocked in environment: {ENVIRONMENT}. "
                "CustomLLM calls are prohibited in test/CI environments."
            )
        
        self.api_key = api_key
        
    async def chat(self, messages, **kwargs):
        # –î—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if BLOCK_EXTERNAL_IO:
            raise RuntimeError("External IO is blocked - CustomLLM calls prohibited")
            
        # –†–µ–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è...
```

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ FakeLLM
```python
# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ FAKE_LLM_MODE
class FakeLLM(BaseLLM):
    async def chat(self, messages, **kwargs):
        if self.mode == "my_custom_mode":
            # –ö–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞
            response = generate_custom_fake_response(messages)
        # ...
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:
1. **–ù–ï –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ** `BLOCK_EXTERNAL_IO=false` –≤ CI/CD
2. **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `@pytest.mark.live_ai` –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. **–ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ** —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–µ—Å—Ç–∞—Ö

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `get_llm()` –∏–ª–∏ `generate_ai_response()`
2. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `response["metadata"]["is_fake"]` –≤ —Ç–µ—Å—Ç–∞—Ö
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ensure_no_tokens_spent()` –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö
4. –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∑–∞—â–∏—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ fake vs real LLM –≤—ã–∑–æ–≤–æ–≤
- –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤ –≤ production
- –ü–æ–ø—ã—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö
- –û—à–∏–±–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ IO

### Alerting:
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–ø—ã—Ç–∫–∞—Ö real LLM –≤—ã–∑–æ–≤–æ–≤ –≤ CI/CD

## FAQ

**Q: –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—Ç?**
```bash
pytest tests/test_token_protection*.py -v
```

**Q: –ö–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É –¥–ª—è debugging?**
```python
# –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è! –¢–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
os.environ["BLOCK_EXTERNAL_IO"] = "false"
```

**Q: –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º LLM?**
```python
@pytest.mark.live_ai
def test_real_llm(live_ai_test):
    """–¢—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Ñ–∏–∫—Å—Ç—É—Ä—ã"""
    # –ö–æ–¥ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
```

**Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç?**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `echo $ENVIRONMENT $LLM_PROVIDER`
2. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pip install -e .`
3. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à: `pytest --cache-clear`
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: `pytest tests/test_token_protection_simple.py`

---

**üõ°Ô∏è –ü–æ–º–Ω–∏—Ç–µ: –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç—Ä–∞—Ç. –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—é–¥–∂–µ—Ç–∞ –∏ rate limiting –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã.**