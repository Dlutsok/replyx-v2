# Страница расходов - Документация

## Обзор

Страница расходов (`/usage`) предоставляет пользователям полный контроль над анализом и мониторингом финансовых операций в платформе ReplyX. Страница выполнена в едином стиле дашборда и включает детальную историю транзакций с мощными инструментами фильтрации.

## Структура страницы

### 1. Welcome Section
- **Заголовок**: "Расходы и аналитика"
- **Описание**: "Статистика использования и история транзакций платформы"
- **Бейдж**: "Онлайн аналитика" с иконкой звезды

### 2. Метрики расходов
Отображает ключевые показатели в виде карточек:
- **Общие расходы**: Сумма всех расходов в рублях
- **Количество операций**: Общее число транзакций
- **Расходы за месяц**: Сумма расходов в текущем месяце
- **Общее количество**: Общее число транзакций

### 3. Основной layout
Двухколоночный layout верхнего уровня:

#### Левая колонка - Статистика
- **Общая статистика**: Контейнер с метриками расходов
- **4 ключевых показателя**: Общие расходы, количество операций, расходы за месяц, общее количество
- **Визуализация**: Карточки с иконками и трендами

#### Правая колонка - Быстрые действия
- **Экспорт данных**: Скачивание отчета в CSV формате
- **Фильтры**: Управление расширенными фильтрами поиска
- **Аналитика**: Переход к детальному анализу (планируется)
- **Советы экономии**: Рекомендации по оптимизации расходов

### 5. История операций
Интегрированный блок с фильтрами и таблицей:

#### Фильтры в заголовке
- **Поиск**: Поле поиска по операциям с иконкой
- **Фильтр по периоду**: Выпадающий список периодов
- **Кнопка фильтров**: Переключение расширенных фильтров
- **Количество операций**: Отображение общего числа записей

#### Расширенные фильтры
- **Тип операции**: Выбор конкретных типов транзакций
- **Сортировка**: По дате, сумме, типу операции
- **Направление сортировки**: Возрастание/убывание

#### Таблица транзакций
Основная таблица с детальной информацией:
- **Операция**: Тип транзакции с иконкой и описанием
- **Дата**: Дата и время выполнения операции
- **Сумма**: Сумма операции (положительная/отрицательная)
- **Баланс**: Баланс после операции

### 6. Пагинация
Управление отображением данных:
- **Навигация по страницам**: Кнопки "Назад/Вперёд"
- **Размер страницы**: Выбор количества записей (25/50/100)
- **Информация о странице**: Текущая страница и общее количество

## Техническая реализация

### Используемые компоненты
- **React hooks**: useState, useEffect для управления состоянием
- **React Icons**: FiActivity, FiTrendingUp, FiDownload и другие
- **Dashboard styles**: Переиспользование стилей дашборда
- **React.createElement**: Безопасный рендеринг динамических иконок
- **QuickActions**: Компонент быстрых действий
- **UsageMetrics**: Компонент метрик расходов

### Функциональность
- **Загрузка данных**: Пагинированная загрузка транзакций
- **Фильтрация**: Поиск, тип операции, период, сортировка
- **Экспорт**: Генерация и скачивание CSV файла
- **Пагинация**: Управление отображением больших объемов данных
- **Двухуровневый layout**: Статистика + действия на верхнем уровне

### Структура компонентов
```javascript
// Основной layout
<div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
  {/* Левая колонка - Статистика */}
  <div className="space-y-6">
    <UsageMetrics stats={stats} total={total} />
  </div>

  {/* Правая колонка - Быстрые действия */}
  <div className="space-y-6">
    <QuickActions onExportClick={exportData} onFilterToggle={...} />
  </div>
</div>

// История операций с интегрированными фильтрами
<div className="bg-white rounded-xl border border-gray-200 p-6">
  {/* Заголовок с фильтрами */}
  <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
    {/* Расширенные фильтры */}
  </div>

  {/* Таблица транзакций */}
  <div className="overflow-x-auto">
    <table>...</table>
  </div>
</div>
```

### Состояние компонента
```javascript
const [transactions, setTransactions] = useState([]);           // Список транзакций
const [loading, setLoading] = useState(true);                   // Состояние загрузки
const [stats, setStats] = useState({...});                      // Статистика расходов
const [filteredTransactions, setFilteredTransactions] = useState([]); // Отфильтрованные данные
const [page, setPage] = useState(1);                           // Текущая страница
const [limit, setLimit] = useState(50);                        // Размер страницы
const [total, setTotal] = useState(0);                         // Общее количество
const [filters, setFilters] = useState({...});                 // Параметры фильтрации
const [showFilters, setShowFilters] = useState(false);          // Видимость фильтров
```

### API интеграция
- **GET /api/balance/transactions/detailed/paged**: Получение пагинированных транзакций
- **GET /api/balance/usage-stats**: Получение статистики расходов
- **CSV экспорт**: Генерация файла на клиенте

## Типы операций

### Категории транзакций
- **AI сообщения**: Сообщения к ассистентам
- **Сообщения виджета**: Взаимодействия через виджет
- **Загрузка документов**: Обработка файлов
- **Сообщения ассистента**: Ответы AI
- **Пополнения**: Входящие платежи

### Иконки операций
Каждый тип операции имеет уникальную иконку:
- AI сообщения: FiMessageSquare
- Виджет: FiGlobe
- Документы: FiFileText
- Ассистент: FiZap
- Пополнения: FiCreditCard

## Стилистика

### Цветовая схема
- **Фиолетовый акцент**: #7C3AED для основных элементов
- **Зеленый**: Для положительных сумм и доходов
- **Красный**: Для расходов и отрицательных сумм
- **Серый**: Для второстепенных элементов

### Адаптивность
- **Мобильные устройства**: Упрощенная таблица, вертикальная пагинация
- **Планшет**: 2 колонки для метрик, адаптивные фильтры
- **Десктоп**: Полная таблица с горизонтальной прокруткой

### Анимации
- **Hover эффекты**: Подсветка строк таблицы
- **Переходы**: Плавные изменения при фильтрации
- **Загрузка**: Анимация при получении данных

## Фильтрация и поиск

### Параметры фильтрации
- **Поиск**: По описанию, email, имени пользователя
- **Тип операции**: Выбор конкретных типов транзакций
- **Период**: Временной диапазон (неделя/месяц/3 месяца/все время)
- **Сортировка**: По дате, сумме, типу операции

### Логика фильтрации
1. **Клиентская фильтрация**: Применение фильтров к загруженным данным
2. **Поиск**: Нечувствительный к регистру поиск по нескольким полям
3. **Сортировка**: Гибкая сортировка по выбранному полю
4. **Пагинация**: Постраничное отображение результатов

## Экспорт данных

### Формат CSV
```csv
Дата,Тип,Сумма,Описание,Баланс после
2024-01-15 14:30,AI сообщения,-5.00,Сообщение к ассистенту,995.00
2024-01-15 15:00,Пополнение,+500.00,Пополнение баланса,1495.00
```

### Функциональность экспорта
- **Генерация файла**: Создание CSV на клиенте
- **Имя файла**: `usage_YYYY-MM-DD.csv`
- **Кодировка**: UTF-8 с BOM для корректного отображения в Excel
- **Размер**: Все отфильтрованные данные

## Производительность

### Оптимизации
- **Пагинация**: Загрузка только необходимых данных
- **Фильтрация**: Клиентская обработка без дополнительных запросов
- **Кеширование**: Сохранение данных в состоянии компонента
- **Дебонсинг**: Отложенная фильтрация при вводе поиска

### Ограничения
- **Максимум записей**: Ограничение размера страницы (25/50/100)
- **Память браузера**: Ограничение на количество загруженных транзакций
- **Скорость фильтрации**: Оптимизация для больших объемов данных

## Доступность

### Клавиатурная навигация
- **Tab**: Перемещение по элементам управления
- **Enter/Space**: Активация кнопок и ссылок
- **Arrow keys**: Навигация по таблице

### Screen readers
- **ARIA-атрибуты**: Правильная семантическая разметка таблицы
- **Alt-тексты**: Описания для иконок и изображений
- **Live regions**: Уведомления об изменениях в данных

## Метрики и аналитика

### Отслеживаемые события
- Просмотр страницы расходов
- Использование фильтров и поиска
- Экспорт данных
- Навигация по страницам
- Время на странице

### Производительность
- **Время загрузки**: Метрики загрузки данных
- **Время фильтрации**: Производительность поиска
- **Размер экспорта**: Объем скачиваемых данных

## Безопасность

### Защита данных
- **Аутентификация**: Проверка токена доступа
- **HTTPS**: Шифрование всех запросов
- **Валидация**: Проверка входных параметров

### Финансовая безопасность
- **Логирование**: Запись всех операций экспорта
- **Ограничения**: Лимиты на объем экспортируемых данных
- **Аудит**: Отслеживание доступа к финансовым данным

## Будущие улучшения

### Планируемые функции
- **Графики и диаграммы**: Визуализация расходов по времени
- **Категоризация**: Группировка расходов по категориям
- **Бюджетирование**: Установка лимитов расходов
- **Уведомления**: Оповещения о превышении лимитов
- **Прогнозы**: Предсказание будущих расходов

### Технические улучшения
- **Виртуализация таблицы**: Для работы с большими объемами данных
- **WebSocket**: Реальное время обновление данных
- **Кеширование**: Оптимизация загрузки данных
- **PWA**: Оффлайн-доступ к истории операций
