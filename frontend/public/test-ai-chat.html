<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç AI –ß–∞—Ç–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        .chat-test {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .response {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        
        .ai-button {
            background: #28a745;
            font-size: 12px;
            padding: 5px 10px;
        }
        
        .ai-button:hover { background: #1e7e34; }
    </style>
</head>
<body>
    <h1>ü§ñ –¢–µ—Å—Ç AI –ß–∞—Ç–∞ ChatAI MVP</h1>
    
    <div class="test-container">
        <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Backend</h2>
        <button onclick="checkBackend()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Backend</button>
        <div id="backend-status"></div>
    </div>
    
    <div class="test-container">
        <h2>2. –°–æ–∑–¥–∞–Ω–∏–µ AI –°–µ—Å—Å–∏–∏</h2>
        <button onclick="createSession()">–°–æ–∑–¥–∞—Ç—å –°–µ—Å—Å–∏—é</button>
        <div id="session-status"></div>
        <div>Session ID: <span id="session-id">-</span></div>
    </div>
    
    <div class="test-container">
        <h2>3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI –ß–∞—Ç–∞</h2>
        <div class="chat-test">
            <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="3"></textarea>
            <button onclick="sendMessage()" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            <div id="chat-responses"></div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>4. –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã</h2>
        <div class="button-group">
            <button onclick="testMessage('–ü—Ä–∏–≤–µ—Ç!')">–¢–µ—Å—Ç: –ü—Ä–∏–≤–µ—Ç!</button>
            <button onclick="testMessage('–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?')">–¢–µ—Å—Ç: –ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?</button>
            <button onclick="testMessage('–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞?')">–¢–µ—Å—Ç: –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞?</button>
            <button onclick="testMessage('–ö–∞–∫–∏–µ —É –≤–∞—Å —Ç–∞—Ä–∏—Ñ—ã?')">–¢–µ—Å—Ç: –¢–∞—Ä–∏—Ñ—ã</button>
            <button onclick="testMessage('–•–æ—á—É –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É')">–¢–µ—Å—Ç: –ó–∞—è–≤–∫–∞</button>
        </div>
    </div>

    <script>
        let sessionId = null;
        let messageCount = 0;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend
        async function checkBackend() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.innerHTML = '<div class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º backend...</div>';
            
            try {
                const response = await fetch('http://localhost:8000/api/system/health');
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç!</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ AI —Å–µ—Å—Å–∏–∏
        async function createSession() {
            const statusDiv = document.getElementById('session-status');
            const sessionIdSpan = document.getElementById('session-id');
            
            statusDiv.innerHTML = '<div class="status info">–°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é...</div>';
            
            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º sessionId
                sessionId = crypto.randomUUID();
                sessionIdSpan.textContent = sessionId;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                const response = await fetch('http://localhost:8000/api/ai/initialize-context', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        context: {
                            companyName: 'ChatAI MVP',
                            serviceDescription: '–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è AI –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è 1000+ Telegram/VK –±–æ—Ç–∞–º–∏',
                            faq: [
                                {
                                    question: '–ß—Ç–æ —Ç–∞–∫–æ–µ ChatAI MVP?',
                                    answer: '–≠—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ AI-–±–æ—Ç–∞–º–∏ –≤ Telegram –∏ VK'
                                },
                                {
                                    question: '–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞?',
                                    answer: '–ó–∞–π–¥–∏—Ç–µ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞" –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º'
                                }
                            ],
                            features: [
                                '–°–æ–∑–¥–∞–Ω–∏–µ AI-–±–æ—Ç–æ–≤ –¥–ª—è Telegram –∏ VK',
                                '–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞',
                                '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI GPT',
                                '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏'
                            ]
                        },
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞!</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            if (!sessionId) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å–µ—Å—Å–∏—é');
                return;
            }
            
            await testMessage(message);
            messageInput.value = '';
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function testMessage(message) {
            const responsesDiv = document.getElementById('chat-responses');
            const sendBtn = document.getElementById('send-btn');
            
            messageCount++;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userMsg = document.createElement('div');
            userMsg.innerHTML = `<div class="response" style="border-left-color: #6c757d;"><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${message}</div>`;
            responsesDiv.appendChild(userMsg);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = '<div class="response"><strong>AI:</strong> <em>–î—É–º–∞—é...</em></div>';
            loadingMsg.id = `loading-${messageCount}`;
            responsesDiv.appendChild(loadingMsg);
            
            sendBtn.disabled = true;
            
            try {
                const response = await fetch('http://localhost:8000/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                loadingMsg.remove();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
                const aiMsg = document.createElement('div');
                let buttonsHtml = '';
                
                if (data.buttons && data.buttons.length > 0) {
                    buttonsHtml = '<div class="button-group">';
                    data.buttons.forEach(button => {
                        buttonsHtml += `<button class="ai-button" onclick="handleButtonClick('${button.action || button.url}', '${button.label}')">${button.label}</button>`;
                    });
                    buttonsHtml += '</div>';
                }
                
                // –ó–∞–º–µ–Ω—è–µ–º \n –Ω–∞ <br> –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
                const formattedMessage = data.message.replace(/\n/g, '<br>');
                
                aiMsg.innerHTML = `
                    <div class="response">
                        <strong>AI:</strong> ${formattedMessage}
                        ${buttonsHtml}
                        <small style="color: #6c757d; display: block; margin-top: 5px;">
                            Provider: ${data.provider_used || 'unknown'}
                        </small>
                    </div>
                `;
                responsesDiv.appendChild(aiMsg);
                
            } catch (error) {
                loadingMsg.innerHTML = `<div class="response" style="border-left-color: #dc3545;"><strong>–û—à–∏–±–∫–∞:</strong> ${error.message}</div>';
            }
            
            sendBtn.disabled = false;
            responsesDiv.scrollTop = responsesDiv.scrollHeight;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ AI –∫–Ω–æ–ø–∫–∏
        function handleButtonClick(action, label) {
            console.log('Button clicked:', action, label);
            
            if (action.startsWith('http') || action.startsWith('/')) {
                window.open(action, '_blank');
            } else {
                alert(`–î–µ–π—Å—Ç–≤–∏–µ: ${action}\n–ö–Ω–æ–ø–∫–∞: ${label}`);
            }
        }

        // –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            checkBackend();
        };
    </script>
</body>
</html>