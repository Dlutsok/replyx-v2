# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

## –¢–µ–∫—É—â–∏–µ –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã ‚úÖ
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤
- [x] MIME-type –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ python-magic
- [x] Path traversal –∑–∞—â–∏—Ç–∞  
- [x] –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- [x] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
- [x] Rate limiting (10 —Ñ–∞–π–ª–æ–≤ –∑–∞ 5 –º–∏–Ω—É—Ç)
- [x] –ò–∑–æ–ª—è—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (/uploads/{user_id}/)

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è üî¥

### 1. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤–∏—Ä—É—Å—ã
```python
# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ClamAV –∏–ª–∏ VirusTotal API
def scan_file_for_viruses(file_path: str) -> bool:
    import pyclamd
    cd = pyclamd.ClamdAgnostic()
    scan_result = cd.scan_file(file_path)
    return scan_result is None  # None = —á–∏—Å—Ç—ã–π —Ñ–∞–π–ª
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Ä–æ—Å–æ–≤ –≤ Office –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö  
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å oletools –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–∞–∫—Ä–æ—Å–æ–≤
from oletools.olevba import VBA_Parser
def check_office_macros(file_path: str) -> bool:
    vba_parser = VBA_Parser(file_path)
    if vba_parser.detect_vba_macros():
        return False  # –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã —Å –º–∞–∫—Ä–æ—Å–∞–º–∏
    return True
```

### 3. PDF JavaScript –¥–µ—Ç–µ–∫—Ü–∏—è
```python
# –ê–Ω–∞–ª–∏–∑ PDF –Ω–∞ –Ω–∞–ª–∏—á–∏–µ JavaScript
import PyPDF2
def check_pdf_javascript(file_path: str) -> bool:
    with open(file_path, 'rb') as f:
        reader = PyPDF2.PdfReader(f)
        for page in reader.pages:
            if '/JS' in str(page) or '/JavaScript' in str(page):
                return False  # –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å PDF —Å JS
    return True
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã üü°

### 4. Sandbox –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```python
# –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
# Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–µ–∑ —Å–µ—Ç–µ–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
```

### 5. –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```python
# 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Üí –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
# 2. –ì–ª—É–±–æ–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
```

### 6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–Ω–æ–º–∞–ª–∏–π
```python
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π:
# - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
# - –§–∞–π–ª—ã —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏  
# - –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ä–∞–∑–º–µ—Ä–∞
```

### 7. Content Security Policy –¥–ª—è PDF
```python
# –ü—Ä–∏ –æ—Ç–¥–∞—á–µ PDF —Ñ–∞–π–ª–æ–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏:
headers = {
    'Content-Security-Policy': "script-src 'none'",
    'X-Content-Type-Options': 'nosniff'
}
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è üîµ

### 8. –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
```python
# –í—ã–¥–µ–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
# –° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
```

### 9. S3/MinIO –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
```python
# –•—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª—ã –≤ S3, –∞ –Ω–µ –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–µ—Ä–≤–µ—Ä–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pre-signed URLs –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
```

### 10. –ö–∞—Ä–∞–Ω—Ç–∏–Ω –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
```python
# –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã 24 —á–∞—Å–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω–µ
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
```

## –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥ —É–ª—É—á—à–µ–Ω–∏–π

### –£–ª—É—á—à–µ–Ω–Ω—ã–π FileValidator:
```python
class EnhancedFileValidator:
    @staticmethod 
    async def deep_scan_file(file_path: str, content: bytes) -> Tuple[bool, str]:
        \"\"\"–ì–ª—É–±–æ–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞\"\"\"
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∏—Ä—É—Å—ã (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω ClamAV)
        try:
            import pyclamd
            cd = pyclamd.ClamdAgnostic()
            if cd.ping():
                scan_result = cd.scan_file(file_path)
                if scan_result:
                    return False, f"–í–∏—Ä—É—Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω: {scan_result}"
        except ImportError:
            logger.warning("ClamAV –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É")
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Ä–æ—Å–æ–≤ –≤ Office —Ñ–∞–π–ª–∞—Ö
        if file_path.endswith(('.doc', '.docx', '.xls', '.xlsx')):
            try:
                from oletools.olevba import VBA_Parser
                vba = VBA_Parser(file_path)
                if vba.detect_vba_macros():
                    return False, "–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç VBA –º–∞–∫—Ä–æ—Å—ã"
            except ImportError:
                logger.warning("oletools –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ PDF JavaScript
        if file_path.endswith('.pdf'):
            try:
                import PyPDF2
                with open(file_path, 'rb') as f:
                    reader = PyPDF2.PdfReader(f)
                    for page in reader.pages:
                        page_content = str(page)
                        if '/JS' in page_content or '/JavaScript' in page_content:
                            return False, "PDF —Å–æ–¥–µ—Ä–∂–∏—Ç JavaScript"
            except Exception as e:
                logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ PDF: {e}")
        
        return True, ""
```

## –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è):

1. **–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã —Å –º–∞–∫—Ä–æ—Å–∞–º–∏** - –¥–æ–±–∞–≤–∏—Ç—å –≤ DANGEROUS_PATTERNS
2. **–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å PDF —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞ JavaScript
3. **–£—Å–∏–ª–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
4. **–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä–∞–Ω—Ç–∏–Ω** - –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã 1 —á–∞—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞** - –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

## –û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–∏—Ö —Ä–∏—Å–∫–æ–≤:
- üü¢ **XSS/JS injection** - –∑–∞—â–∏—â–µ–Ω—ã (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
- üü¢ **Path traversal** - –∑–∞—â–∏—â–µ–Ω—ã (–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–µ–π) 
- üü¢ **Executable files** - –∑–∞—â–∏—â–µ–Ω—ã (–±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π)
- üü° **Office –º–∞–∫—Ä–æ—Å—ã** - –ù–ï –∑–∞—â–∏—â–µ–Ω—ã (–Ω—É–∂–Ω—ã oletools)
- üü° **PDF JavaScript** - –ù–ï –∑–∞—â–∏—â–µ–Ω—ã (–Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞)
- üî¥ **–í–∏—Ä—É—Å—ã/–º–∞–ª–≤–∞—Ä—å** - –ù–ï –∑–∞—â–∏—â–µ–Ω—ã (–Ω—É–∂–µ–Ω –∞–Ω—Ç–∏–≤–∏—Ä—É—Å)